<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="Stedfast as thou art."/><link rel="alternate" href="/atom.xml" title="Calios' Eden"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="http://www.caliosd.gq/page/8/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-71292392-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-71292392-1');
</script><script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":false};
</script>

    <title>Calios' Eden</title>
  <link rel="alternate" href="/atom.xml" title="Calios' Eden" type="application/atom+xml">
</head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Calios' Eden</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Calios' Eden</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><section id="posts" class="posts"><article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2016/01/28/[SourceCodeRead]-SDWebImage-1/">[SourceCodeRead] SDWebImage-1</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-01-28
        </span></div>
    </header>

    <div class="post-content"><p><a href="https://github.com/rs/SDWebImage" title="https://github.com/rs/SDWebImage" target="_blank" rel="external">SDWebImage</a>作为一个将服务器远程的图片获取到UIImageView上显示的一个第三方类库，于我而言，最为常用的API莫过于<code>-sd_setImageWithURL: placeholderImage:</code>方法。不妨以此入手，拨开它源代码的神秘面纱。</p>
<hr>
<p><img src="http://7xkwcv.com1.z0.glb.clouddn.com/QQ20160506-0.png" alt="" title="UIImage+WebCache.m片段"></p>
<p>点入.m文件，发现上图中从上至下的一列方法，都依次指向相邻的下一个方法，不过在上层调用时个别参数置为<code>nil</code>或<code>0</code>。直到<code>-sd_setImageWithURL: placeholderImage:options:progress:completed:</code>这个<strong>核心方法</strong>，方见端倪。<br><figure class="highlight erlang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- <span class="params">(void)</span>sd_setImageWithURL:<span class="params">(NSURL *)</span>url placeholderImage:<span class="params">(UIImage *)</span>placeholder options:<span class="params">(SDWebImageOptions)</span>options progress:<span class="params">(SDWebImageDownloaderProgressBlock)</span>progressBlock completed:<span class="params">(SDWebImageCompletionBlock)</span>completedBlock &#123;</div><div class="line">    [self sd_cancelCurrentImageLoad];</div><div class="line">    objc_setAssociatedObject<span class="params">(self, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC)</span>; // [1]</div><div class="line"></div><div class="line">    if <span class="params">(!(options &amp; SDWebImageDelayPlaceholder)</span>) &#123; // [2]</div><div class="line">        dispatch_main_async_safe<span class="params">(^&#123;</span></div><div class="line">            self.image = placeholder;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="［1］objc-setAssociatedObject"><a href="#［1］objc-setAssociatedObject" class="headerlink" title="［1］objc_setAssociatedObject"></a>［1］objc_setAssociatedObject</h3><h4 id="1-这货是什么？"><a href="#1-这货是什么？" class="headerlink" title="1. 这货是什么？"></a>1. 这货是什么？</h4><p>根据苹果的<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/ObjCRuntimeRef/#//apple_ref/c/func/objc_setAssociatedObject" title="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/ObjCRuntimeRef/#//apple_ref/c/func/objc_setAssociatedObject" target="_blank" rel="external">官方文档</a>：</p>
<blockquote>
<p><code>objc_setAssociatedObject</code>是Objective－C运行时的一个函数，它可以将两个对象关联起来。这个函数需要四个参数：原对象，一个键，一个值，和一个关联策略的常量。其中，键是一个void指针。</p>
<ul>
<li>每个关联的键都必须是唯一的。通常的做法是使用一个静态变量。</li>
<li>关联策略指定了被关联的对象是assigned，retained，copied还是atomic/nonatomic。这个形式和声明property是类似的。可以用常量来指定这种关系。</li>
</ul>
</blockquote>
<h4 id="2-什么场景下会使用？"><a href="#2-什么场景下会使用？" class="headerlink" title="2. 什么场景下会使用？"></a>2. 什么场景下会使用？</h4><p><a href="http://stackoverflow.com/a/16313377/1594792" title="http://stackoverflow.com/a/16313377/1594792" target="_blank" rel="external">abbood</a>将它的使用场景归结为如下几点：</p>
<p>(1)给类别（category）添加实例变量。</p>
<p>假设你想给你不能修改的对象（比如说苹果官方提供的对象，UIImage、UILabel神马的。注意：我们这里讨论的是修改对象本身，不包括将其子类化。）的类别中添加个自定义的属性（<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/CustomizingExistingClasses/CustomizingExistingClasses.html" title="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/CustomizingExistingClasses/CustomizingExistingClasses.html" target="_blank" rel="external">这几乎是Objective-C最大的缺点</a>），比如说，我们想给<code>UIImage</code>添加一个title的属性。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UIImage-Title.h:</span></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIImage</span>(<span class="title">Title</span>)</span></div><div class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *title;</div><div class="line"><span class="keyword">@end</span></div><div class="line"></div><div class="line"><span class="comment">// UIImage-Title.m:</span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> titleKey;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIImage</span>(<span class="title">Title</span>)</span></div><div class="line">- (<span class="built_in">NSString</span> *)title</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, &amp;titleKey);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)setTitle:(<span class="built_in">NSString</span> *)title</div><div class="line">&#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, &amp;titleKey, title, OBJC_ASSOCIATION_COPY);</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>(2)动态地给对象添加状态信息，而这个对象的实例变量即便结合KVO也不能达到目的。（有点拗口，慢慢理解。。）</p>
<p>意思是说，你的对象只有在runtime期间（也就是说，动态地）才能获取状态信息。所以，尽管你可以把状态信息存在实例变量中，但实际上你是要在runtime期间把这个信息和对象绑定起来、并且动态地把它和另一个对象关联，要强调的是<strong>这是一个对象的动态状态</strong>这个事实。</p>
<p>如下是一个不错的<a href="https://github.com/alexzielenski/ZKRevealingTableViewCell/blob/master/vendor/ZKRevealingTableViewCell.m" title="https://github.com/alexzielenski/ZKRevealingTableViewCell/blob/master/vendor/ZKRevealingTableViewCell.m" target="_blank" rel="external">例子</a>中的一个片段，在这个例子中，关联对象使用了KVO通知，但KVO并不是关联对象的必要条件。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> BOOLRevealing;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)isRevealing</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [(<span class="built_in">NSNumber</span>*)objc_getAssociatedObject(<span class="keyword">self</span>, &amp;BOOLRevealing) boolValue];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)_setRevealing:(<span class="built_in">BOOL</span>)revealing</div><div class="line">&#123;</div><div class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"isRevealing"</span>];</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, &amp;BOOLRevealing,</div><div class="line">       [<span class="built_in">NSNumber</span> numberWithBool:revealing], OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"isRevealing"</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>引一段<em>SDWebImage</em>中的代码，纯正的、不含KVO的长这样子：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setShowActivityIndicatorView:(<span class="built_in">BOOL</span>)show&#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, &amp;TAG_ACTIVITY_SHOW, [<span class="built_in">NSNumber</span> numberWithBool:show], OBJC_ASSOCIATION_RETAIN);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">BOOL</span>)showActivityIndicatorView&#123;</div><div class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, &amp;TAG_ACTIVITY_SHOW) boolValue];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，<code>TAG_ACTIVITY_SHOW</code>的定义如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> TAG_ACTIVITY_SHOW;</div></pre></td></tr></table></figure></p>
<h4 id="3-此处作用"><a href="#3-此处作用" class="headerlink" title="3. 此处作用"></a>3. 此处作用</h4><p>所以，这里相当于给UIImageView的category添加了一个<code>imageURLKey</code>的属性，我猜想，是用来表示图片资源的唯一性的key。</p>
<h3 id="［2］-amp"><a href="#［2］-amp" class="headerlink" title="［2］&amp;"></a>［2］&amp;</h3><h4 id="为什么这里用-amp-而不是-amp-amp-呢？"><a href="#为什么这里用-amp-而不是-amp-amp-呢？" class="headerlink" title="为什么这里用&amp;而不是&amp;&amp;呢？"></a>为什么这里用<code>&amp;</code>而不是<code>&amp;&amp;</code>呢？</h4><p>趁机捡一捡基础知识：</p>
<p><code>&amp;</code>是按位运算的双目运算符，功能是参与将运算的两个数各自对应的二进位相与。<br>例如：9&amp;5可以写算式：00001001 &amp; 00000101 ＝ 00000001，即 9 &amp; 5 = 1。</p>
<p><code>&amp;&amp;</code>检查第一个操作数的值，如果为false，就不再处理第二个操作数，直接返回false。</p>
<p>所以，这里的<code>(options &amp; SDWebImageDelayPlaceholder)</code>，是两个枚举值进行按位运算，而非我们平常写的true/false的布尔判断。</p>
<p>随手点入枚举值的定义，发现这一堆：<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">typedef <span class="type">NS_OPTIONS</span>(<span class="type">NSUInteger</span>, <span class="type">SDWebImageOptions</span>) &#123;</div><div class="line">    /**</div><div class="line">     * <span class="type">By</span> default, when a <span class="type">URL</span> fail to be downloaded, the <span class="type">URL</span> is blacklisted so the library won't keep trying.</div><div class="line">     * <span class="type">This</span> flag disable this blacklisting.</div><div class="line">     */</div><div class="line">    <span class="type">SDWebImageRetryFailed</span> = 1 &lt;&lt; 0, // [3]</div><div class="line"></div><div class="line">    /**</div><div class="line">     * <span class="type">By</span> default, image downloads are started during <span class="type">UI</span> interactions, this flags disable this feature,</div><div class="line">     * leading to delayed download on <span class="type">UIScrollView</span> deceleration for instance.</div><div class="line">     */</div><div class="line">    <span class="type">SDWebImageLowPriority</span> = 1 &lt;&lt; 1,</div><div class="line"></div><div class="line">    /**</div><div class="line">     * <span class="type">This</span> flag disables on-disk caching</div><div class="line">     */</div><div class="line">    <span class="type">SDWebImageCacheMemoryOnly</span> = 1 &lt;&lt; 2,</div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>而其实<code>SDWebImageDelayPlaceholder</code>正是这一群枚举值中的一个。所以猜测，这句代码的意思是说，传入的<code>option</code>为包含<code>SDWebImageDelayPlaceholder</code>时该如何如何……（可为嘛曲曲折折地不直说呢？=_=|||） 但还是没有解决为什么用<code>&amp;</code>而不用<code>&amp;&amp;</code>的问题。仔细一看，这里的枚举并非自己平时使用的<code>NS_ENUM</code>，而是<code>NS_OPTIONS</code>。简而言之，二者本质上是一样的，<code>NS_ENUM</code>是比较通用的情况，而位掩码时用<code>NS_OPTIONS</code>，具体的解释可以看<a href="http://nshipster.com/ns_enum-ns_options/" title="http://nshipster.com/ns_enum-ns_options/" target="_blank" rel="external">Mattt的这篇</a>。</p>
<p><strong> ———— 20160216更新———— </strong><br>鉴于后期越来越多的位运算出现，过期的薄底子hold不住了。这里举一个例子，更多详细介绍参考<a href="http://www.cnblogs.com/cute/p/3786283.html" title="http://www.cnblogs.com/cute/p/3786283.html" target="_blank" rel="external">这篇</a>。<br><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">typedef NS_OPTIONS(NSUInteger, MyOption) &#123;</div><div class="line">    MyOptionNone = <span class="number">0</span>, <span class="comment">//二进制0000,十进制0</span></div><div class="line">    MyOption1 = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,<span class="comment">//0001,1</span></div><div class="line">    MyOption2 = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,<span class="comment">//0010,2</span></div><div class="line">    MyOption3 = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,<span class="comment">//0100,4</span></div><div class="line">    MyOption4 = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,<span class="comment">//1000,8</span></div><div class="line">&#125;;</div><div class="line">##使用:</div><div class="line"><span class="comment">//声明定义枚举变量</span></div><div class="line">MyOption option = MyOption1 | MyOption2;<span class="comment">//0001 | 0010 = 0011,3</span></div><div class="line"></div><div class="line"><span class="comment">//检查是否包含某选型</span></div><div class="line">if ( <span class="keyword">option</span> &amp; MyOption3 )&#123; <span class="comment">//0011 &amp; 0100 = 0000</span></div><div class="line">     <span class="comment">//包含MyOption3</span></div><div class="line">&#125;else&#123;</div><div class="line">     <span class="comment">//不包含MyOption3</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//增加选项:</span></div><div class="line"><span class="keyword">option</span> = <span class="keyword">option</span> | MyOption4;<span class="comment">//0011 | 1000 = 1011, 11</span></div><div class="line"><span class="comment">//减少选项</span></div><div class="line"><span class="keyword">option</span> = <span class="keyword">option</span> &amp; (~MyOption4);<span class="comment">//1011 &amp; (~1000) = 1011 &amp; 0111 = 0011, 3</span></div></pre></td></tr></table></figure></p>
<p>我的理解是，Bitwise <code>AND</code>，即<code>&amp;</code>，相当于两个option取交集；Bitwise <code>OR</code>，即<code>|</code>，相当于两个option取并集。</p>
<p>关于<code>NS_OPTIONS</code>和<code>NS_ENUM</code>的差别，后来查到的orkoden的<a href="http://stackoverflow.com/a/21384671/1594792" target="_blank" rel="external">回答</a>一语中的😂：</p>
<blockquote>
<p>There’s a basic difference between an enum and a bitmask (option). You use an enum to list exclusive states. A bitmask is used when several properties can apply at the same time.</p>
</blockquote>
<p><strong> ———— 20160216更新结束———— </strong></p>
<h3 id="［3］-lt-lt"><a href="#［3］-lt-lt" class="headerlink" title="［3］\&lt;\&lt;"></a>［3］\&lt;\&lt;</h3><p><code>&lt;&lt;</code>为按位左移运算符。具体它<a href="http://stackoverflow.com/questions/141525/what-are-bitwise-shift-bit-shift-operators-and-how-do-they-work" title="http://stackoverflow.com/questions/141525/what-are-bitwise-shift-bit-shift-operators-and-how-do-they-work" target="_blank" rel="external">是什么以及怎样运算</a>，这里略去不提了。简单举例如下：<br>SDWebImageAvoidAutoSetImage<br>    1 &lt;&lt; 2 即 二进制的100 ＝ 十进制 2的平方<br>    1 &lt;&lt; 3 即 二进制的1000 ＝ 十进制 2的3次方</p>
<p>所以，<code>1 &lt;&lt; n</code>，即二进制1左位移n位，相当于十进制2的n次方。</p>
<h3 id="［4］宏定义"><a href="#［4］宏定义" class="headerlink" title="［4］宏定义"></a>［4］宏定义</h3><p><code>dispatch_main_sync_safe</code>和<code>dispatch_main_async_safe</code>是SDWebImage定义的两个宏。若当前是主线程，则执行block；若不是主线程，则在主线程中同步/异步之行block。<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#define dispatch_main_sync_safe(block)\</span></div><div class="line">    <span class="keyword">if</span> ([NSThread isMainThread]) &#123;<span class="string">\</span></div><div class="line">        block();<span class="string">\</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;<span class="string">\</span></div><div class="line">        dispatch_sync(dispatch_get_main_queue(), block);<span class="string">\</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">#define dispatch_main_async_safe(block)\</span></div><div class="line">    <span class="keyword">if</span> ([NSThread isMainThread]) &#123;<span class="string">\</span></div><div class="line">        block();<span class="string">\</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;<span class="string">\</span></div><div class="line">        dispatch_async(dispatch_get_main_queue(), block);<span class="string">\</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>每行后面的反斜杠<code>\</code>表示在不影响含义的条件下换行，需注意要在回车之前加反斜杠<code>\</code>。</p>
<p>再看一个常见的宏定义。<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define DLog(<span class="name">fmt</span>, ...)    NSLog( @<span class="string">"&lt;%@:(%d)&gt; %s \n ----- %@"</span>, [[NSString stringWithUTF8String<span class="symbol">:__FILE__</span>] lastPathComponent], __LINE__, __func__, [NSString stringWithFormat:(<span class="name">fmt</span>), ##__VA_ARGS__] )</div></pre></td></tr></table></figure></p>
<p>这个用于Log的宏定义中，有这样几点需要解释的：</p>
<ul>
<li><code>DLog(fmt, ...)</code>的第二个参数<code>...</code>。在宏定义的时候，写为…的参数被叫做可变参数(variadic)，其个数是不限定的。在这里，第一个参数fmt将被单独处理，后面的参数将被作为整体看待。</li>
<li>通常前后被<code>__</code>包围的都是预定义宏。如这里的<code>__FILE__</code>（当前文件的绝对路径），<code>__LINE__</code>（在文件中的行数），<code>__func__</code>（该宏所在的行所属的函数名）。</li>
<li><code>##__VA_ARGS__</code>表示的是宏定义中的…中的所有剩余参数。打头的<code>##</code>表示将两个参数连接起来这种运算。</li>
</ul>
<h3 id="［5］SDWebImageOptions中几个有趣的枚举值"><a href="#［5］SDWebImageOptions中几个有趣的枚举值" class="headerlink" title="［5］SDWebImageOptions中几个有趣的枚举值"></a>［5］<code>SDWebImageOptions</code>中几个有趣的枚举值</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">typedef NS_OPTIONS(NSUInteger, SDWebImageOptions) &#123;</div><div class="line">    ...</div><div class="line">    /**</div><div class="line">     * By default, placeholder images are loaded <span class="keyword">while</span> <span class="keyword">the</span> image <span class="keyword">is</span> loading. This flag will <span class="built_in">delay</span> <span class="keyword">the</span> loading</div><div class="line">     * <span class="keyword">of</span> <span class="keyword">the</span> placeholder image <span class="keyword">until</span> <span class="keyword">after</span> <span class="keyword">the</span> image has finished loading.</div><div class="line">     */</div><div class="line">    SDWebImageDelayPlaceholder = <span class="number">1</span> &lt;&lt; <span class="number">9</span>,</div><div class="line">    ...</div><div class="line">        /**</div><div class="line">     * By default, image <span class="keyword">is</span> added <span class="keyword">to</span> <span class="keyword">the</span> imageView <span class="keyword">after</span> download. But <span class="keyword">in</span> <span class="keyword">some</span> cases, we want <span class="keyword">to</span></div><div class="line">     * have <span class="keyword">the</span> hand <span class="keyword">before</span> setting <span class="keyword">the</span> image (apply a filter <span class="keyword">or</span> add <span class="keyword">it</span> <span class="keyword">with</span> cross-fade animation <span class="keyword">for</span> instance)</div><div class="line">     * Use this flag <span class="keyword">if</span> you want <span class="keyword">to</span> manually <span class="keyword">set</span> <span class="keyword">the</span> image <span class="keyword">in</span> <span class="keyword">the</span> completion when success</div><div class="line">     */</div><div class="line">    SDWebImageAvoidAutoSetImage = <span class="number">1</span> &lt;&lt; <span class="number">11</span></div></pre></td></tr></table></figure>
<p>在上面提到的<strong>核心方法</strong>中，有这样几个<code>SDWebImageOptions</code>引起了我的注意。</p>
<p>一个是<code>SDWebImageDelayPlaceholder</code>。说是默认情况下，placeholder的图片会在网络图片加载的过程中就被加载完毕，这个flag会将placeholder图片等加载延迟到网络图片完成加载之后。所以这里<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">if</span> (!(options &amp; SDWebImageDelayPlaceholder)) &#123; <span class="comment">// [2]</span></div><div class="line">    dispatch_main_async_safe(^&#123;</div><div class="line">        self.<span class="built_in">image</span> = placeholder;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>是说如果使用者传入的<code>options</code>不是<code>SDWebImageDelayPlaceholder</code>，就正常地把placeholder图片赋给当前的<code>imageView</code>。之前第一遍看时没有看懂，原来就是“负负得正”的意思。</p>
<p>另一个是<code>SDWebImageAvoidAutoSetImage</code>。默认情况下，图片会在下载完毕后<em>自动</em>添加给<code>imageView</code>。但有些时候，比如说我们想在设置图片之前加一些图片处理（加个滤镜或者渐变动画之类的），就需要在下载成功时<em>手动</em>使用这个flag来设置图片了。<strong>以后想实现类似效果就知道该在哪里设置什么参数了。</strong><br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="built_in">image</span> &amp;&amp; (options &amp; SDWebImageAvoidAutoSetImage) &amp;&amp; completedBlock)</div><div class="line">&#123;</div><div class="line">        completedBlock(<span class="built_in">image</span>, <span class="built_in">error</span>, cacheType, url);</div><div class="line">        <span class="built_in">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所以这里判断，如果image不为空，而<code>options</code>表明需要增加图片处理，且加载完成的<code>completeBlock</code>不为空，那么就代入参数，执行<code>completeBlock</code>。</p>
<h3 id="［6］setNeedsLayout和layoutIfNeeded"><a href="#［6］setNeedsLayout和layoutIfNeeded" class="headerlink" title="［6］setNeedsLayout和layoutIfNeeded"></a>［6］<code>setNeedsLayout</code>和<code>layoutIfNeeded</code></h3><p>接着上面的if判断：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">else</span> <span class="built_in">if</span> (<span class="built_in">image</span>)</div><div class="line">&#123;</div><div class="line">         wself.<span class="built_in">image</span> = <span class="built_in">image</span>;</div><div class="line">         [wself setNeedsLayout];</div><div class="line">&#125;</div><div class="line"><span class="built_in">else</span> &#123;</div><div class="line">          <span class="built_in">if</span> ((options &amp; SDWebImageDelayPlaceholder)) &#123;</div><div class="line">                  wself.<span class="built_in">image</span> = placeholder;</div><div class="line">                  [wself setNeedsLayout];</div><div class="line">          &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>如果后两个条件中至少有一个不满足，那么就直接将image赋给当前的<code>imageView</code>，并调用<code>setNeedsLayout</code>将其标记为需要重新布局；如果image为空，而<code>options</code>表明需要延迟加载placeholder图片，那么就将placeholder图片赋给当前<code>imageView</code>，并将其标记为需要重新布局。</p>
<p>与<code>setNeedsLayout</code>紧密相关的<code>layoutIfNeeded</code>用于实现布局。比如使用了AutoLayout的<code>UITableViewCell</code>中经常会这样二者连着写：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)layoutSubviews</div><div class="line">&#123;</div><div class="line">    [<span class="meta">super layoutSubviews</span>];</div><div class="line"></div><div class="line">    [<span class="meta">self.contentView setNeedsLayout</span>];</div><div class="line">    [<span class="meta">self.contentView layoutIfNeeded</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>具体iOS绘制UI的原理及步骤，这里算是给自己挖了个坑吧，以后看懂了、研究明白了再慢慢填上。</p>
<hr>
<p><strong>Ref：</strong></p>
<ul>
<li><p><a href="http://stackoverflow.com/questions/5909412/what-is-objc-setassociatedobject-and-in-what-cases-should-it-be-used/16313377#16313377" target="_blank" rel="external">http://stackoverflow.com/questions/5909412/what-is-objc-setassociatedobject-and-in-what-cases-should-it-be-used/16313377#16313377</a></p>
</li>
<li><p>Mattt的真迹：<a href="http://nshipster.com/associated-objects/" target="_blank" rel="external">http://nshipster.com/associated-objects/</a></p>
</li>
<li>中文版：<a href="http://nshipster.cn/associated-objects/" target="_blank" rel="external">http://nshipster.cn/associated-objects/</a></li>
<li>喵神讲解宏定义黑魔法的一篇：<a href="http://onevcat.com/2014/01/black-magic-in-macro/" target="_blank" rel="external">http://onevcat.com/2014/01/black-magic-in-macro/</a></li>
<li>关于位运算：<a href="http://www.cnblogs.com/cute/p/3786283.html" target="_blank" rel="external">http://www.cnblogs.com/cute/p/3786283.html</a></li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2016/01/28/essay-soul-in-programming-170127/">0127-所谓技术知识体系</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-01-28
        </span></div>
    </header>

    <div class="post-content"><blockquote>
<p>武功百诀，以意为先，那才是武功的精骨神髓；招式身法，都不过是皮毛而已。若无精骨，皮毛何在？但若得了武道神髓。再学皮毛便是易如反掌了。 ——《浣花洗剑录》</p>
</blockquote>
<p>最近在思考构建技术知识体系的问题，读到这句，忽然福至心灵而有所感。</p>
<p>所谓高大沉重的基础知识，如数据库、计算机网络、操作系统、数据结构之类，无非是相当于武功中的神韵，因为他们不依附于某种语言而存在，如流水，生生不息。而具体的某种语言、某一种具体的领域则是那百家兵器排行榜上的一位，有其锐不可当的部分，也有看似纷繁复杂但又门户大开的部分。</p>
<p>所谓大学者，无非是在练就我们的基本功，让我们领悟计算机技术的精髓，不至于为语言、技术之众多迷花了眼。可惜，当初的我们身在森林而不知树木，噫吁嚱！</p>
<p>所以，对于技术知识体系，不妨两条腿走路，一方面，在具体的实践中不断深挖，多问几个为什么，比如研究AFNetworking的源码，就可以顺便追究一下网络传输的原理；另一方面，从基础知识入手，系统地整理一下网络自顶向下的七层结构。如此一来，方能融会贯通。</p>
<p>曾看慶写过，说构建知识体系就像是看地图，要不断地放大、缩小：放大时，一个小镇都会变得很大，街道、楼房，事无巨细；缩小时，纵观全国、全世界，横向的比较才有意义。如今想来，恍有所悟，终于从接受变成了理解。</p>
<p>于是，便不再烦躁对于服务器方面的学习该使用哪种语言、哪种技术，因为一通百通，具体的哪一种就没那么重要了。岁月长河中，终是有那一波又一波的语言和技术倒在沙滩上，不变的，是千淘万漉的河底鹅卵，历经冲刷而日渐滑润，熠熠生辉。</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2016/01/21/how-not-to-crash-8-infrastructure/">【译】如何避免程序崩溃-8：基本架构</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-01-21
        </span></div>
    </header>

    <div class="post-content"><p>原文链接：<a href="http://inessential.com/2015/06/10/how_not_to_crash_8_infrastructure" target="_blank" rel="external">http://inessential.com/2015/06/10/how_not_to_crash_8_infrastructure</a></p>
<hr>
<p>即使你觉得自己的app是无故障的，你也需要收集崩溃日志 —— 因为没有什么是无故障的：只有<em>已知</em>的崩溃bug是可以避免的。</p>
<p>有一些做这类事情的服务，我尝试过的还都不错，所以我在这里就不做特别推荐了。</p>
<p>有几点功能是它应该具备的：</p>
<ol>
<li>崩溃日志被收集的过程，不需要用户手动查找它们再发送给你。它应该是自动化的（如果在OS X上，用户可能会收到提示；而在iOS上没人会希望被弹窗）。</li>
<li>要有给崩溃日志分组的机制，你得到的应该是每一组的汇总，这样你就能知道哪些经常出现，哪些不经常出现。</li>
<li>要能够给一组问题标记为已解决。</li>
</ol>
<p>当然，仅仅收集崩溃日志是远远不够的。你应该定期查看它们。（我每天早上查看崩溃日志。）</p>
<h4 id="Bug跟踪器"><a href="#Bug跟踪器" class="headerlink" title="Bug跟踪器"></a>Bug跟踪器</h4><p>要有一个。</p>
<p>对于我私人的项目，我会综合使用Lighthouse，OmniOutliner和纸笔 —— 当然你可以使用任何工具，只要你的崩溃记录归总到你的bug跟踪器里面而不会遗失。</p>
<p>（Lighthouse是个不错的bug跟踪器。我喜欢用OmniOutliner来标记大的新功能或者完整的app，在那里我可以建立to do的事件树。对于短周期的事情 —— 比如完成一个10步就可以完成的任务 —— 我喜欢用纸笔，因为依赖短期记忆很让人疲倦，而纸笔不会干扰屏幕上的上下文环境。）</p>
<h4 id="错误和警告"><a href="#错误和警告" class="headerlink" title="错误和警告"></a>错误和警告</h4><p>Xcode默认不会打开足够的错误和警告。我强烈推荐<a href="http://boredzo.org/blog/archives/2009-11-07/warnings" title="http://boredzo.org/blog/archives/2009-11-07/warnings" target="_blank" rel="external">Peter Hosey的集合</a>。</p>
<p>关键是要移除你代码中的<em>不确定性</em>。</p>
<p>就像我推荐的，我更进一步：我像对待错误一样对待警告。是的，这就意味着，如果警告存在我甚至不能在本地debug —— 但是这条守则物有所值。它意味着无论何时，只要我的app在运行，就不存在任何警告。</p>
<h4 id="Instruments"><a href="#Instruments" class="headerlink" title="Instruments"></a>Instruments</h4><p>Instruments非常棒。查看你的app分配了多少的内存是个好主意，同时，查看内存泄漏也是非常重要的。</p>
<p>如果你的app崩溃了，使用Zombies工具是个好主意。你的问题可能和zombies并没有关系，但是在怀疑的过程中，排除法是很值得使用的。</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2016/01/19/commands-in-git/">实用git命令</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-01-19
        </span></div>
    </header>

    <div class="post-content"><h4 id="状态相关"><a href="#状态相关" class="headerlink" title="状态相关"></a>状态相关</h4><ul>
<li>撤销 <code>git commit</code> 之前的 <code>git add</code> ：<code>git reset &lt;file&gt;</code></li>
<li>替换本地改动，会使用HEAD中的最新内容替换掉工作目录中的文件，已添加到暂存区及新文件都不会受到影响：<code>git checkout -- &lt;filename&gt;</code></li>
<li>丢弃本地所有改动和提交，获取服务器最新版本历史，并将本地主分支指向它：<code>git fetch origin</code>, <code>git reset --hard origin/master</code></li>
</ul>
<h4 id="分支相关"><a href="#分支相关" class="headerlink" title="分支相关"></a>分支相关</h4><ul>
<li>查看远程分支：<code>git branch -a</code></li>
<li>查看本地分支：<code>git branch</code></li>
<li>创建分支：<code>git branch newBranch</code></li>
<li>把分支推到远程分支：<code>git push origin newBranch</code></li>
<li>把远程分支pull下来：<code>git clone --branch develop --single-branch XXurl</code></li>
<li>切换分支：<code>git checkout newBranch</code></li>
<li>删除远程分支: <code>git push origin --delete &lt;branchName&gt;</code></li>
<li>删除本地分支：<code>git branch -D fixVersion</code></li>
<li>合并改动前，预览差异：<code>git diff &lt;source_branch&gt; &lt;target_branch&gt;</code></li>
<li>查看远程信息：<code>git remote show origin</code><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">remote origin</div><div class="line">  Fetch URL: https:<span class="comment">//github.com/WilliamZang/reactivecocoa_practise.git</span></div><div class="line">  Push  URL: https:<span class="comment">//github.com/WilliamZang/reactivecocoa_practise.git</span></div><div class="line">  HEAD branch: master</div><div class="line">  Remote branches:</div><div class="line">    lesson1          tracked</div><div class="line">    lesson2          tracked</div><div class="line">    lesson3          tracked</div><div class="line">    lesson4          tracked</div><div class="line">    lesson5          tracked</div><div class="line">    lesson6          tracked</div><div class="line">    master           tracked</div><div class="line">    practise2        tracked</div><div class="line">    practise2_answer tracked</div><div class="line">    practise3        tracked</div><div class="line">    practise3_answer tracked</div><div class="line">  <span class="keyword">Local</span> branches configured <span class="keyword">for</span> <span class="string">'git pull'</span>:</div><div class="line">    master           merges <span class="keyword">with</span> remote master</div><div class="line">    practise2        merges <span class="keyword">with</span> remote practise2</div><div class="line">    practise2_answer merges <span class="keyword">with</span> remote practise2_answer</div><div class="line">  <span class="keyword">Local</span> refs configured <span class="keyword">for</span> <span class="string">'git push'</span>:</div><div class="line">    lesson6          pushes <span class="keyword">to</span> lesson6          (<span class="keyword">local</span> <span class="keyword">out</span> <span class="keyword">of</span> date)</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="Cheatsheet"><a href="#Cheatsheet" class="headerlink" title="Cheatsheet"></a>Cheatsheet</h4><p><img src="http://7xkwcv.com1.z0.glb.clouddn.com/git-cheat-sheet.png" alt="git cheat sheet"></p>
<p>源文件在<a href="http://rogerdudler.github.io/git-guide/files/git_cheat_sheet.pdf" target="_blank" rel="external">这里</a>。</p>
<hr>
<p><strong>Ref:</strong></p>
<p><a href="http://rogerdudler.github.io/git-guide/index.zh.html" target="_blank" rel="external">http://rogerdudler.github.io/git-guide/index.zh.html</a></p>
<p><a href="http://stackoverflow.com/questions/348170/undo-git-add-before-commit" target="_blank" rel="external">http://stackoverflow.com/questions/348170/undo-git-add-before-commit</a></p>
<p><a href="http://stackoverflow.com/questions/927358/how-do-you-undo-the-last-commit" target="_blank" rel="external">http://stackoverflow.com/questions/927358/how-do-you-undo-the-last-commit</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2016/01/19/commands-in-LLVM/">LLDB常用命令</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-01-19
        </span></div>
    </header>

    <div class="post-content"><h4 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h4><p><strong>po：</strong> 打印出对象的description描述。<br>这里列出几个常用的场景：</p>
<ul>
<li>查看KVO的详细信息：</li>
</ul>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">po <span class="string">[observedObject observationInfo]</span></div></pre></td></tr></table></figure>
<ul>
<li>查看AutoLayout布局的view的层级结构，需在<code>layoutSublayersOfLayer:</code>方法中添加断点。详参<a href="http://www.calios.gq/2015/09/10/AutoLayout-debug/" target="_blank" rel="external">这篇</a>。</li>
</ul>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">po <span class="string">[self _autolayoutTrace]</span></div></pre></td></tr></table></figure>
<p><strong>e：</strong> 在当前程序环境中，执行任何的表达式，并且可以定义和操作已存在的变量。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> e result = []</span></div></pre></td></tr></table></figure>
<h4 id="控制流快捷命令"><a href="#控制流快捷命令" class="headerlink" title="控制流快捷命令"></a>控制流快捷命令</h4><ul>
<li><code>n</code>，Step Over</li>
<li><code>s</code>, Step Into</li>
<li><code>finish</code>, Step Out</li>
<li><code>c</code>, 恢复程序执行操作<br><code>thread return</code>：不但可以使当前的函数返回，而且还可以任意修改当前函数的返回值，而不管传进来的参数如何。</li>
</ul>
<h4 id="断点创建命令"><a href="#断点创建命令" class="headerlink" title="断点创建命令"></a>断点创建命令</h4><figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(lldb) breakpoint <span class="built_in">set</span> -f ViewController.swift -l <span class="number">28</span></div><div class="line">Breakpoint <span class="number">2</span>: <span class="keyword">where</span> = <span class="keyword">Example</span>`<span class="keyword">Example</span>.ViewController.viewDidLoad (<span class="keyword">Example</span>.ViewController)() -&gt; () + <span class="number">478</span> <span class="built_in">at</span> ViewController.swift:<span class="number">29</span>, address= <span class="number">0x000000010f74f61e</span></div></pre></td></tr></table></figure>
<p>简写：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">b</span> ViewController<span class="selector-class">.swift</span>:<span class="number">28</span></div><div class="line"><span class="selector-tag">b</span> add （add为函数名）</div></pre></td></tr></table></figure></p>
<h4 id="一点Chisel"><a href="#一点Chisel" class="headerlink" title="一点Chisel"></a>一点Chisel</h4><p>查看命令用法：<code>help [command]</code></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">(lldb) help pviews</div><div class="line">Print <span class="keyword">the</span> recursion description <span class="keyword">of</span> ~&lt;aView&gt;~.</div><div class="line"></div><div class="line">Arguments:</div><div class="line">  ~&lt;aView&gt;~; Type: UIView*/NSView*; The view <span class="built_in">to</span> print <span class="keyword">the</span> description <span class="keyword">of</span>.</div><div class="line"></div><div class="line">Options:</div><div class="line">  <span class="comment">--up/-u ; Print only the hierarchy directly above the view, up to its window.</span></div><div class="line">  <span class="comment">--depth/-d ~&lt;depth&gt;~; Type: int; Print only to a given depth. 0 indicates infinite depth.</span></div><div class="line"></div><div class="line">Syntax: pviews \[<span class="comment">--up] \[--depth=depth] ~&lt;aView&gt;~</span></div><div class="line"></div><div class="line">This <span class="keyword">command</span> <span class="title">is</span> <span class="title">implemented</span> <span class="title">as</span> <span class="title">FBPrintViewHierarchyCommand</span> <span class="title">in</span> /<span class="title">usr</span>/<span class="title">local</span>/<span class="title">Cellar</span>/<span class="title">chisel</span>/<span class="title">1</span><span class="number">.2</span><span class="number">.0</span>/<span class="title">libexec</span>/<span class="title">commands</span>/<span class="title">FBPrintCommands</span>.<span class="title">py</span>.</div><div class="line"></div><div class="line">(LLDB adds <span class="keyword">the</span> next <span class="built_in">line</span>, sorry...)</div></pre></td></tr></table></figure>
<p>查看view的层级结构的 <em>原生命令</em>：</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(lldb) po <span class="comment">[<span class="comment">[<span class="comment">[UIApplication sharedApplication]</span> keyWindow]</span> recursiveDescription]</span></div></pre></td></tr></table></figure>
<p>Chisel的简化版：<code>pviews</code></p>
<ul>
<li>语法为：<code>pviews [--up] [--depth=depth] &lt;aView&gt;</code></li>
<li>可以添加以下参数：<ul>
<li>–up/-u：只打印直属于当前view的层级关系。最高层为它的window。</li>
<li>–depth/-d <depth>：只打印指定层数，0意味着不限制层数。</depth></li>
</ul>
</li>
</ul>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="xml">(lldb) pviews</span></div><div class="line"><span class="tag">&lt;<span class="name">UIWindow:</span> <span class="attr">0x7f994423a3a0</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">768</span> <span class="attr">1024</span>); <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">gestureRecognizers</span> = &lt;<span class="attr">NSArray:</span> <span class="attr">0x7f994423abc0</span>&gt;</span>; layer = <span class="tag">&lt;<span class="name">UIWindowLayer:</span> <span class="attr">0x7f9944239e90</span>&gt;</span>&gt;</div><div class="line">   | <span class="tag">&lt;<span class="name">UILayoutContainerView:</span> <span class="attr">0x7f9943d4a160</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">768</span> <span class="attr">1024</span>); <span class="attr">transform</span> = <span class="string">[0,</span> <span class="attr">-1</span>, <span class="attr">1</span>, <span class="attr">0</span>, <span class="attr">0</span>, <span class="attr">0</span>]; <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943d4a380</span>&gt;</span>&gt;</div><div class="line">   |    | <span class="tag">&lt;<span class="name">UITransitionView:</span> <span class="attr">0x7f9943d4bbc0</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">768</span>); <span class="attr">clipsToBounds</span> = <span class="string">YES;</span> <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943d4be00</span>&gt;</span>&gt;</div><div class="line">   |    |    | <span class="tag">&lt;<span class="name">UIViewControllerWrapperView:</span> <span class="attr">0x7f9943cb7b30</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">768</span>); <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943cb8380</span>&gt;</span>&gt;</div><div class="line">   |    |    |    | <span class="tag">&lt;<span class="name">UILayoutContainerView:</span> <span class="attr">0x7f994412f9c0</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">768</span>); <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">gestureRecognizers</span> = &lt;<span class="attr">NSArray:</span> <span class="attr">0x7f9943c67c30</span>&gt;</span>; layer = <span class="tag">&lt;<span class="name">CALayer:</span> <span class="attr">0x7f994412fba0</span>&gt;</span>&gt;</div><div class="line">   |    |    |    |    | <span class="tag">&lt;<span class="name">UINavigationTransitionView:</span> <span class="attr">0x7f9943c606f0</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">768</span>); <span class="attr">clipsToBounds</span> = <span class="string">YES;</span> <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943c13890</span>&gt;</span>&gt;</div><div class="line">   |    |    |    |    |    | <span class="tag">&lt;<span class="name">UIViewControllerWrapperView:</span> <span class="attr">0x7f994426d090</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">768</span>); <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f994426ce70</span>&gt;</span>&gt;</div><div class="line">   |    |    |    |    |    |    | <span class="tag">&lt;<span class="name">UIView:</span> <span class="attr">0x7f994423db60</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">768</span>); <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f994423dad0</span>&gt;</span>&gt;</div><div class="line">   |    |    |    |    |    |    |    | <span class="tag">&lt;<span class="name">UICollectionView:</span> <span class="attr">0x7f9944838000</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">768</span>); <span class="attr">clipsToBounds</span> = <span class="string">YES;</span> <span class="attr">gestureRecognizers</span> = &lt;<span class="attr">NSArray:</span> <span class="attr">0x7f9944241220</span>&gt;</span>; layer = <span class="tag">&lt;<span class="name">CALayer:</span> <span class="attr">0x7f9944240a30</span>&gt;</span>; contentOffset: <span class="template-variable">&#123;0, -64&#125;</span><span class="xml">&gt; collection view layout: <span class="tag">&lt;<span class="name">UICollectionViewFlowLayout:</span> <span class="attr">0x7f994423fca0</span>&gt;</span></span></div><div class="line">   ... ...</div><div class="line"></div><div class="line">(lldb) pviews --up</div><div class="line"><span class="tag">&lt;<span class="name">UIWindow:</span> <span class="attr">0x7f994423a3a0</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">768</span> <span class="attr">1024</span>); <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">gestureRecognizers</span> = &lt;<span class="attr">NSArray:</span> <span class="attr">0x7f994423abc0</span>&gt;</span>; layer = <span class="tag">&lt;<span class="name">UIWindowLayer:</span> <span class="attr">0x7f9944239e90</span>&gt;</span>&gt;</div><div class="line"></div><div class="line">(lldb) pviews --depth=5 0x7f9943d4ad60</div><div class="line"><span class="tag">&lt;<span class="name">UITabBar:</span> <span class="attr">0x7f9943d4ad60</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">712</span>; <span class="attr">1024</span> <span class="attr">56</span>); <span class="attr">autoresize</span> = <span class="string">W+TM;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943d4b1a0</span>&gt;</span>&gt;</div><div class="line">   | <span class="tag">&lt;<span class="name">_UITabBarBackgroundView:</span> <span class="attr">0x7f994423b920</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">56</span>); <span class="attr">autoresize</span> = <span class="string">W;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f994423bae0</span>&gt;</span>&gt;</div><div class="line">   |    | <span class="tag">&lt;<span class="name">_UIBackdropView:</span> <span class="attr">0x7f994423bb00</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">56</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">_UIBackdropViewLayer:</span> <span class="attr">0x7f994423bdd0</span>&gt;</span>&gt;</div><div class="line">   |    |    | <span class="tag">&lt;<span class="name">_UIBackdropEffectView:</span> <span class="attr">0x7f994423c320</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">56</span>); <span class="attr">clipsToBounds</span> = <span class="string">YES;</span> <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CABackdropLayer:</span> <span class="attr">0x7f994423bac0</span>&gt;</span>&gt;</div><div class="line">   |    |    | <span class="tag">&lt;<span class="name">UIView:</span> <span class="attr">0x7f994423c4f0</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">0</span>; <span class="attr">1024</span> <span class="attr">56</span>); <span class="attr">hidden</span> = <span class="string">YES;</span> <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">autoresize</span> = <span class="string">W+H;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f994423c5b0</span>&gt;</span>&gt;</div><div class="line">   | <span class="tag">&lt;<span class="name">UITabBarButton:</span> <span class="attr">0x7f9943c8fd20</span>; <span class="attr">frame</span> = <span class="string">(309</span> <span class="attr">1</span>; <span class="attr">76</span> <span class="attr">55</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943c923e0</span>&gt;</span>&gt;</div><div class="line">   |    | <span class="tag">&lt;<span class="name">UITabBarSwappableImageView:</span> <span class="attr">0x7f9943c92900</span>; <span class="attr">frame</span> = <span class="string">(25.5</span> <span class="attr">7</span>; <span class="attr">25</span> <span class="attr">25</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943c92b70</span>&gt;</span>&gt;</div><div class="line">   |    | <span class="tag">&lt;<span class="name">UITabBarButtonLabel:</span> <span class="attr">0x7f9943c902f0</span>; <span class="attr">frame</span> = <span class="string">(24</span> <span class="attr">35</span>; <span class="attr">28</span> <span class="attr">17</span>); <span class="attr">text</span> = <span class="string">'首页'</span>; <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943c90590</span>&gt;</span>&gt;</div><div class="line">   | <span class="tag">&lt;<span class="name">UITabBarButton:</span> <span class="attr">0x7f9943c9bf20</span>; <span class="attr">frame</span> = <span class="string">(419</span> <span class="attr">1</span>; <span class="attr">76</span> <span class="attr">55</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943c9d520</span>&gt;</span>&gt;</div><div class="line">   |    | <span class="tag">&lt;<span class="name">UITabBarSwappableImageView:</span> <span class="attr">0x7f9943c9d910</span>; <span class="attr">frame</span> = <span class="string">(25.5</span> <span class="attr">8</span>; <span class="attr">25</span> <span class="attr">23</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943c9d540</span>&gt;</span>&gt;</div><div class="line">   |    | <span class="tag">&lt;<span class="name">UITabBarButtonLabel:</span> <span class="attr">0x7f9943c9c0c0</span>; <span class="attr">frame</span> = <span class="string">(24</span> <span class="attr">35</span>; <span class="attr">28</span> <span class="attr">17</span>); <span class="attr">text</span> = <span class="string">'课程'</span>; <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943c9be40</span>&gt;</span>&gt;</div><div class="line">   | <span class="tag">&lt;<span class="name">UITabBarButton:</span> <span class="attr">0x7f9943ca5450</span>; <span class="attr">frame</span> = <span class="string">(529</span> <span class="attr">1</span>; <span class="attr">76</span> <span class="attr">55</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943ca6a50</span>&gt;</span>&gt;</div><div class="line">   |    | <span class="tag">&lt;<span class="name">UITabBarSwappableImageView:</span> <span class="attr">0x7f9943ca6d40</span>; <span class="attr">frame</span> = <span class="string">(25.5</span> <span class="attr">7</span>; <span class="attr">25</span> <span class="attr">25</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943ca6a70</span>&gt;</span>&gt;</div><div class="line">   |    | <span class="tag">&lt;<span class="name">UITabBarButtonLabel:</span> <span class="attr">0x7f9943ca55f0</span>; <span class="attr">frame</span> = <span class="string">(17</span> <span class="attr">35</span>; <span class="attr">42</span> <span class="attr">17</span>); <span class="attr">text</span> = <span class="string">'讨论区'</span>; <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943ca5370</span>&gt;</span>&gt;</div><div class="line">   | <span class="tag">&lt;<span class="name">UITabBarButton:</span> <span class="attr">0x7f9943caeaa0</span>; <span class="attr">frame</span> = <span class="string">(639</span> <span class="attr">1</span>; <span class="attr">76</span> <span class="attr">55</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943cb0070</span>&gt;</span>&gt;</div><div class="line">   |    | <span class="tag">&lt;<span class="name">UITabBarSwappableImageView:</span> <span class="attr">0x7f9943cb0350</span>; <span class="attr">frame</span> = <span class="string">(26</span> <span class="attr">7.5</span>; <span class="attr">24</span> <span class="attr">24</span>); <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943cb0090</span>&gt;</span>&gt;</div><div class="line">   |    | <span class="tag">&lt;<span class="name">UITabBarButtonLabel:</span> <span class="attr">0x7f9943caec40</span>; <span class="attr">frame</span> = <span class="string">(31</span> <span class="attr">35</span>; <span class="attr">14</span> <span class="attr">17</span>); <span class="attr">text</span> = <span class="string">'我'</span>; <span class="attr">opaque</span> = <span class="string">NO;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f9943cae9a0</span>&gt;</span>&gt;</div><div class="line">   | <span class="tag">&lt;<span class="name">UIImageView:</span> <span class="attr">0x7f994423d490</span>; <span class="attr">frame</span> = <span class="string">(0</span> <span class="attr">-0.5</span>; <span class="attr">1024</span> <span class="attr">0.5</span>); <span class="attr">autoresize</span> = <span class="string">W;</span> <span class="attr">userInteractionEnabled</span> = <span class="string">NO;</span> <span class="attr">layer</span> = &lt;<span class="attr">CALayer:</span> <span class="attr">0x7f994423d590</span>&gt;</span>&gt;</div></pre></td></tr></table></figure>
<p>刷新显示的原生命令：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(lldb) e (<span class="keyword">void</span>)[CATransaction <span class="built_in">flush</span>]</div></pre></td></tr></table></figure>
<p>Chisel的简化版：<code>caflush</code></p>
<hr>
<p><strong>Ref:</strong></p>
<ul>
<li><p>与调试器共舞 - LLDB 的华尔兹(objccn.io): <a href="http://objccn.io/issue-19-2/" target="_blank" rel="external">http://objccn.io/issue-19-2/</a></p>
</li>
<li><p>LLDB使用篇（上）: <a href="http://www.dreamingwish.com/article/lldb-usage-a.html" target="_blank" rel="external">http://www.dreamingwish.com/article/lldb-usage-a.html</a></p>
</li>
<li><p>LLDB篇2教你使用faceBook的chisel来提高调试效率: <a href="http://www.jianshu.com/p/b2371dd4443b#" target="_blank" rel="external">http://www.jianshu.com/p/b2371dd4443b</a></p>
</li>
<li><p><a href="http://swiftcafe.io/2015/09/05/lldb-debug/" target="_blank" rel="external">http://swiftcafe.io/2015/09/05/lldb-debug/</a></p>
</li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/12/19/how-not-to-crash-7-dealing-with-nothing/">【译】如何避免程序崩溃-7：什么都不做</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-12-19
        </span></div>
    </header>

    <div class="post-content"><p>原文链接：<a href="http://inessential.com/2015/05/29/how_not_to_crash_7_dealing_with_nothin" target="_blank" rel="external">http://inessential.com/2015/05/29/how_not_to_crash_7_dealing_with_nothin</a></p>
<hr>
<p>考虑下这行代码：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="section">[thing doStuff]</span><span class="comment">;</span></div></pre></td></tr></table></figure>
<p>如果<code>thing</code>是nil，没有什么问题。不会崩溃。什么都不会发生。</p>
<p>但是你不能由此推断nil在所有场景中都没有问题：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="section">[self doStuff:thing]</span><span class="comment">;</span></div></pre></td></tr></table></figure>
<p>如果<code>thing</code>是nil，接下来会发生什么？如果取决于<code>doStuff:</code>的实现 —— 它可能会崩溃。考虑下这行代码：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">menuItem.title = thing<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>如果<code>menuItem</code>是一个NSMenuItem对象，那么当<code>thing</code>为nil时它就会崩溃。NSMenuItem的头文件没有提到这个，就连文档中也只是一笔带过（“如果你不想要标题，就用一个空字符串代替（@“”），而不是nil。”）</p>
<p>这就意味着你需要保证<code>thing</code>是非空的。你可能很确信它是非空的。但是考虑下我曾经遇到的一个例子，当<code>thing</code>是一个字体的名字时怎么办。我从不会想到获取字体名字的系统API会返回nil —— 除非它偶尔这么做了（当然时很少发生，而且不管我做什么，从未在我的机器上发生）。</p>
<p>需要知道的是：</p>
<p>Nil的接受者是没问题的 —— 只要你的代码对于什么都不做没什么问题。</p>
<p>Nil作为参数可能没问题，也可能有问题。当调用系统的API时，头文件和文档不会总是告诉你可能发生什么。（这一点可能会在他们充分利用<a href="https://developer.apple.com/swift/blog/?id=25" title="https://developer.apple.com/swift/blog/?id=25" target="_blank" rel="external"><code>_Nullable</code>和<code>_Nonnull</code></a>时有所改善。）</p>
<p>不要相信任何人。</p>
<h4 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h4><p>断言是一种证明假设和需求的不错的方式，也是确保假设为真的有效工具。断言不该在发布版本中运行（详见Xcode设置中的ENABLE_NS_ASSERTIONS）。</p>
<p>我最喜欢的一个是NSParameterAssert，我几乎专门用它来做不能为空参数的为空检查。</p>
<p>用起来超级简单：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)someMethod:(<span class="keyword">id</span>)someParameter &#123;</div><div class="line">  <span class="built_in">NSParameterAssert</span>(someParameter);</div><div class="line">  …<span class="keyword">do</span> whatever…</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以后我可能开始使用<code>_Nullable</code>/<code>_Nonnull</code>注释<em>和</em>NSParameterAssert。两个都用。（未来我可能会写些Swift的代码，那时候对于nil的处理就是另一回事了。但是那不是我今天谈论的内容，一部分的原因是，我对于Swift还不足以称为专家，不能给出好的建议。）</p>
<p>我也经常使用NSAssert。NSAssert需要一个表达式和一个评论文字 —— 但我很懒，总把评论置为空。（这种情况下是没问题的。）<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NSAssert(<span class="name">something</span> == somethingElse, <span class="literal">nil</span>)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>（关于懒惰的一点建议：懒的程序员从不写崩溃的bug，因为他们不想之后再回来修复它们。）</p>
<h4 id="我喜欢的崩溃的bug"><a href="#我喜欢的崩溃的bug" class="headerlink" title="我喜欢的崩溃的bug"></a>我喜欢的崩溃的bug</h4><p>几年前，我的app NetNewsWire有一个崩溃日志捕捉者。在启动应用时，它会从磁盘中抓取最新的崩溃日志发送给我。</p>
<p>随着一些OS X系统的发布（我想是10.5）苹果公司修改了磁盘中崩溃日志的形式。我想它们曾经是每个应用一个日志文件，然后苹果改成了每次崩溃一个日志文件。我不得不写些新的代码来处理新的形式。</p>
<p>我做了修改。发给了beta版的测试者，他们专门用这个app。几周过去了。一切安好。</p>
<p>然后，就在我发布这个版本的当天，我接到了成千上万的报告者说，“在启动应用的时候就挂掉了！但是再次启动的时候就好了。”</p>
<p>解决方法如下：新的代码会在根本没有崩溃日志的时候崩溃掉。然后，在下次启动的时候 —— 既然有了崩溃日志 ——它就不会崩溃了。（是的，这是个可以自愈的崩溃bug。在崩溃日志捕捉器内。就是这样。）</p>
<p>当然这就意味着对所有<em>新</em>用户来说，它会立即崩溃，而不只是那些足够幸运、从未崩溃过的人们。</p>
<p>这对我是个极大的提醒：<em>一定要考虑什么都没有的情况</em>。总是什么都不发生。什么都没有是很平常的。但是可能需要特殊处理，也应该被考虑到。</p>
<h4 id="一个没那么酷的崩溃bug"><a href="#一个没那么酷的崩溃bug" class="headerlink" title="一个没那么酷的崩溃bug"></a>一个没那么酷的崩溃bug</h4><p>我认为这不会转移 —— 我想它只存在于beta版的代码中。</p>
<p>Vesper的同步会与服务器对话。服务器将JSON数据返回。Cocoa的JSON解析器将JSON的null转化成<code>NSNull</code>对象。</p>
<p>Vesper期望得到一个NSString，却得到了一个NSNull。Vesper试图对NSNull调用一个字符串的方法，然后它就挂掉了。</p>
<p>表面上看来这是一个难啃的骨头，因为你不能保证JSON给出的类型是你想要的。你需要一个string，但得到了一个NSNull。</p>
<p>是的，NSNull是你希望能够尽量隔离处理的众多对象中的一个。它是个四处游走的问题代码（尽管我不知道在JSON的null的例子中类似的例子是什么）。（你绝不应该在JSON之外特意使用它。几乎绝不应该。绝对少用。比如说几年用一次，而且得是你真的真的不得不用的时候。可能连那样都不应该用。）</p>
<p>这就是像我<a href="http://www.caliosd.gq/2015/11/19/how-not-to-crash-4-threading/" title="http://www.caliosd.gq/2015/11/19/how-not-to-crash-4-threading/">之前那篇</a>提到的，我喜欢把JSON转化成中间对象的部分原因吧。这么做的一大部分工作就集中在处理NSNull对象上 —— 我不想把它们渗透到应用的其它部分上去，那样所到之处都会变得脏兮兮的。</p>
<p>但是，另一个观点是：<em>只要是写服务器端的人，就是你不共戴天的仇人</em>。他非常非常的恨你。</p>
<p>在这里，Vesper的案例中，是我扮演了这样的角色。但我仍然要假设写服务器那家伙把完成我本人和事业的摧毁当作他们的终极目标一样地写代码。（尽管我了解那个家伙，他很酷。他喜欢小猫咪。）同时，那不意味着只检查NSNull —— 不管怎样它在JSON中很常见 —— 而是要对每一部分数据的类型都谨慎处理。</p>
<p>任何事情都可能在不确定的时间变成不可预知的事情。</p>
<p>（并非一路通畅。你期望能够一帆风顺 —— 但是那也太容易了。可能一路下来什么都没有。）</p>
<h4 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h4><p>初始化你的变量。就这样。如果我每修复一个仅仅将变量初始化为nil就解决的崩溃bug就能拿到一个硬币的话 —— 那我已经有好些硬币了。你肯定希望不要获得这样的硬币。</p>
<p>不初始化你的变量就像在玩汽油，然后还说，没问题的，因为火柴在口袋里。</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/12/15/pitfall-1/">Cell的复用机制</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-12-15
        </span></div>
    </header>

    <div class="post-content"><h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>最近踩到了一个以前没有注意的坑。场景是这个样子的。</p>
<blockquote>
<p>一个UICollectionView有个自定义的UICollectionViewCell，UICollectionViewCell中有个UITableView，在点击UITableView的cell时，需要将点击之后更新的model（为一个NSArray）传出来给UICollectionView，UICollectionView用一个NSMutableDictionary接。<br>假设用delegate一层层传出来。<br>会出现这样的问题：</p>
<ul>
<li>Cell0中，点击UITableView的cell，传出来的值为<code>@[@&quot;0&quot;]</code>，UICollectionView接到的值为<code>@[@&quot;0&quot;]</code>，更新后的字典为<code>@{ 0 = (0);}</code>；</li>
<li>水平滑动collectionView，显示Cell1，点击UITableView的cell， UITableView传出来的值为<code>@[@&quot;1&quot;]</code>，UICollectionView接到的值为<code>@[@&quot;1&quot;]</code>，更新后的字典为<code>@{ 0 = (0); 1 = (0);}</code>；</li>
<li>继续水平滑动collectionView，显示Cell2，点击UITableView的cell， UITableView传出来的值为<code>@[@&quot;6&quot;]</code>，UICollectionView接到的值为<code>@[@&quot;6&quot;]</code>，更新后的字典为<code>@{ 0 = (6); 1 = (0); 2 = (6);}</code>；</li>
<li>问题出现了，key为2的value会把key为0的value覆盖掉。</li>
<li>所以呢？</li>
</ul>
</blockquote>
<p>一入小坑深似海，从此清闲是路人。</p>
<p>此处略去十几根青丝。</p>
<p>还好，某日正午的咖啡香中，灵光闪现。很可能是key为2的value和key为0的value对应相同的地址。所以，2的value就把0的value给覆盖了。打断点依次打印了一下更新后字典中各个元素的地址，果然如此。</p>
<p>爬出来了。</p>
<h4 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h4><p>导致这个问题的表面原因，可能是由于UICollectionViewCell的复用机制。在每页显示一个cell的情况下，当显示index0的cell，假设其中成员变量的指向的地址为<em>0x00001</em>，；当显示index2的cell时，复用了index0的cell，同样也就复用了其中的成员变量，即上文中传出来的数组。而在调用delegate方法时，直接就把这个数组作为参数传入。接下来层层代理出来，最终collectionView获得的值也是换汤不换药地指向原来数组的地址<em>0x00001</em>。所以就导致UICollectionView中字典key为0和key为2的值相同。</p>
<p>深究原因的话，还是代码的防御性不强。从别处获取的值不应该拿过来就直接使用，而应该复制给一个新的变量，之后自己继续用这个新的变量。反过来，作为传出去的参数，最好也能略微封装一下，不要把private的成员变量直接就传出去，防止引入外面的污染。</p>
<p><strong>PS：</strong><br>当然，对于从UITableView传值出去，通知机制会更方便些，免得一层层的写代理。但也要注意同样的问题。提高自己代码的健壮性。</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/12/14/auto-layout-best-practices-for-minimum-pain/">【译】Auto Layout的最佳实践 —— 止疼片</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-12-14
        </span></div>
    </header>

    <div class="post-content"><p>原文链接：<a href="https://medium.com/@NSomar/auto-layout-best-practices-for-minimum-pain-c130b2b1a0f6#.tqby1u8l4" target="_blank" rel="external">https://medium.com/@NSomar/auto-layout-best-practices-for-minimum-pain-c130b2b1a0f6#.tqby1u8l4</a></p>
<hr>
<p>Auto Layout是个很棒的工具，作为开发者，它可以让我们保持神志清醒，还能让我们这些懒人们在设置frame的时候远离“神奇数字”。</p>
<p>但是任何技术都不是完美无缺的，我必须得说我花了太多的时间来debug那些缺失的约束条件，或者对于一些藏在层级结构深处的视图，添加一个冲突的约束条件就会把整个布局毁掉，当这些事情发生的时候简直是天崩地裂！</p>
<p>在debug了无数个小时的auto layout的问题后，我发现每次造成问题的都是我自己（或者是你自己！），而问题的解决办法总是相同的：遵从auto layout的文档和规则！</p>
<p>我会在这里把正确使用auto layout的最佳实践说给你听，这样你就可以免除一些痛苦了。</p>
<h4 id="UIView的子类应该实现intrinsicContentSize方法"><a href="#UIView的子类应该实现intrinsicContentSize方法" class="headerlink" title="UIView的子类应该实现intrinsicContentSize方法"></a>UIView的子类应该实现intrinsicContentSize方法</h4><p>每个<em>UIView</em>的子类都应该实现<em>intrinsicContentSize</em>，并且返回它认为合适的大小。</p>
<p>假设我们新建了一个<em>AwesomeView</em>，而且我们知道这个view的默认尺寸是300x20，我们会这么写：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-(<span class="built_in">CGSize</span>)intrinsicContentSize &#123;</div><div class="line"> <span class="keyword">return</span> <span class="built_in">CGSizeMake</span>(<span class="number">300</span>, <span class="number">20</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果我们不知道view的宽度，我们会用<em>UIViewNoIntrinsicMetric</em>来代替：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">CGSize</span>)intrinsicContentSize &#123;</div><div class="line"> <span class="keyword">return</span> <span class="built_in">CGSizeMake</span>(<span class="built_in">UIViewNoIntrinsicMetric</span>, <span class="number">20</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>UIView基类的<em>updateConstraints</em>实现会调用<em>intrinsicContentSize</em>，它会使用返回的尺寸来给<em>AwesomeView</em>添加约束条件。</p>
<p>根据上面例子中的(300,20)尺寸，会添加下面的约束条件：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="string">NSContentSizeLayoutConstraint:</span><span class="number">0x7fef48d52580</span> <span class="string">H:</span>[<span class="string">AwesomeView:</span><span class="number">0x7fef48ead7f0</span>(<span class="number">300</span>)] <span class="string">Hug:</span><span class="number">250</span> <span class="string">CompressionResistance:</span><span class="number">750</span>&gt;,</div><div class="line">&lt;<span class="string">NSContentSizeLayoutConstraint:</span><span class="number">0x7fef48d4d110</span> <span class="string">V:</span>[<span class="string">AwesomeView:</span><span class="number">0x7fef48ead7f0</span>(<span class="number">20</span>)] <span class="string">Hug:</span><span class="number">250</span> <span class="string">CompressionResistance:</span><span class="number">750</span>&gt;</div></pre></td></tr></table></figure></p>
<p>添加的约束条件比较特殊，它们是<em>NSContentSizeLayoutConstraint</em>类型的，这个类是个私有类。这些约束条件的优先级范围是0-1000，“包住限制”（译者注：hug consistance，使其在“内容大小”的基础上不能继续变大）的优先级是250，“撑住限制”（compression resistance，撑住使其在在其“内容大小”的基础上不能继续变小）的优先级是750，使用的常量等于通过<em>intrinsicContentSize</em>返回的值。</p>
<p>请注意，UIView基类实现<strong>updateConstraints</strong>只有在它第一次执行的时候才会添加<em>intrinsicContentSize</em>约束。</p>
<h4 id="UIView的子类绝不应该给自身的尺寸添加约束"><a href="#UIView的子类绝不应该给自身的尺寸添加约束" class="headerlink" title="UIView的子类绝不应该给自身的尺寸添加约束"></a>UIView的子类绝不应该给自身的尺寸添加约束</h4><p>每个view都会负责给它的superview设置约束，但是view<strong>绝不应该</strong>设置它自己的约束条件，不管是对于自身的约束（比如说<em> NSLayoutAttributeWidth</em>和<em> NSLayoutAttributeHeight</em>），还是相对于superview的约束。</p>
<p>如果一个view想指定自己的高度或者宽度，它应该通过实现<em> intrinsicContentSize</em>来达到目的。</p>
<p>这是个糟糕的例子：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (instancetype)init</div><div class="line">&#123;</div><div class="line">     self = [<span class="keyword">super</span> init];</div><div class="line">     <span class="keyword">if</span> (self) &#123;</div><div class="line">         [self <span class="string">addConstraint:</span>[NSLayoutConstraint <span class="string">constraintWithItem:</span>self <span class="string">attribute:</span>NSLayoutAttributeWidth <span class="string">relatedBy:</span>NSLayoutRelationEqual <span class="string">toItem:</span>nil <span class="string">attribute:</span><span class="number">0</span> <span class="string">multiplier:</span><span class="number">0</span> <span class="string">constant:</span><span class="number">100</span>]];</div><div class="line">         [self <span class="string">addConstraint:</span>[NSLayoutConstraint <span class="string">constraintWithItem:</span>self <span class="string">attribute:</span>NSLayoutAttributeHeight <span class="string">relatedBy:</span>NSLayoutRelationEqual <span class="string">toItem:</span>nil <span class="string">attribute:</span><span class="number">0</span> <span class="string">multiplier:</span><span class="number">0</span> <span class="string">constant:</span><span class="number">100</span>]];</div><div class="line">     &#125;</div><div class="line">         <span class="keyword">return</span> self;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个view在通过给自身添加约束来设置自己的宽度和高度，那么如果现在它的superview也在试图指定这些数值会发生什么呢？<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Some place in the superview</span></div><div class="line">[awesome <span class="string">addConstraint:</span>[NSLayoutConstraint <span class="string">constraintWithItem:</span>awesome <span class="string">attribute:</span>NSLayoutAttributeWidth <span class="string">relatedBy:</span>NSLayoutRelationEqual <span class="string">toItem:</span>nil <span class="string">attribute:</span><span class="number">0</span> <span class="string">multiplier:</span><span class="number">0</span> <span class="string">constant:</span><span class="number">200</span>]];</div><div class="line">[awesome <span class="string">addConstraint:</span>[NSLayoutConstraint <span class="string">constraintWithItem:</span>awesome <span class="string">attribute:</span>NSLayoutAttributeHeight <span class="string">relatedBy:</span>NSLayoutRelationEqual <span class="string">toItem:</span>nil <span class="string">attribute:</span><span class="number">0</span> <span class="string">multiplier:</span><span class="number">0</span> <span class="string">constant:</span><span class="number">200</span>]];</div></pre></td></tr></table></figure></p>
<p>嘭！<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Unable to simultaneously satisfy constraints.</div><div class="line">…</div><div class="line">property translatesAutoresizingMaskIntoConstraints)</div><div class="line">(</div><div class="line"> “&lt;<span class="string">NSLayoutConstraint:</span><span class="number">0x7ff3b16c2ae0</span> <span class="string">H:</span>[<span class="string">AwesomeView:</span><span class="number">0x7ff3b16bfa00</span>(<span class="number">100</span>)]&gt;”,</div><div class="line"> “&lt;<span class="string">NSLayoutConstraint:</span><span class="number">0x7ff3b16c2330</span> <span class="string">H:</span>[<span class="string">AwesomeView:</span><span class="number">0x7ff3b16bfa00</span>(<span class="number">200</span>)]&gt;”</div><div class="line">)</div><div class="line">Will attempt to recover by breaking constraint</div><div class="line">&lt;<span class="string">NSLayoutConstraint:</span><span class="number">0x7ff3b16c2330</span> <span class="string">H:</span>[<span class="string">AwesomeView:</span><span class="number">0x7ff3b16bfa00</span>(<span class="number">200</span>)]&gt;</div><div class="line">…</div></pre></td></tr></table></figure></p>
<p><code>AwesomeView</code>添加的宽度/高度是100/100，而它的superview也添加了宽度/高度，但是是200/200，这样autoLayout就不知道该选择哪个约束条件了，因为它们的优先级都一样。</p>
<p>一种解决办法是这样的，将<code>AwesomeView</code>自身的优先级降低一点。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[self <span class="string">addConstraint:</span>(&#123;</div><div class="line"> NSLayoutConstraint *constraint;</div><div class="line"> constraint = [NSLayoutConstraint <span class="string">constraintWithItem:</span>self <span class="string">attribute:</span>NSLayoutAttributeWidth <span class="string">relatedBy:</span>NSLayoutRelationEqual <span class="string">toItem:</span>nil <span class="string">attribute:</span><span class="number">0</span> <span class="string">multiplier:</span><span class="number">0</span> <span class="string">constant:</span><span class="number">100</span>];</div><div class="line"> constraint.priority = <span class="number">800</span>;</div><div class="line"> constraint;</div><div class="line"> &#125;)];</div></pre></td></tr></table></figure>
<p>这样autoLayout就可以做出选择了，因为它自身添加的优先级比较低，它就可以选择superview添加的约束了。</p>
<p>然而，尽管这样可以解决问题，但正确的方式是通过<em> intrinsicContentSize</em>来指定它的高度。</p>
<h4 id="UIView的子类绝不应该给它的superview添加约束"><a href="#UIView的子类绝不应该给它的superview添加约束" class="headerlink" title="UIView的子类绝不应该给它的superview添加约束"></a>UIView的子类绝不应该给它的superview添加约束</h4><p>和上面的原因一样，子视图绝不应该给他的父视图添加约束。子视图的位置是由父视图决定的。</p>
<p>像这么做很糟糕：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)didMoveToSuperview &#123;</div><div class="line">     [<span class="keyword">super</span> didMoveToSuperview];</div><div class="line">     [self.superview <span class="string">addConstraint:</span>[NSLayoutConstraint <span class="string">constraintWithItem:</span>self <span class="string">attribute:</span>NSLayoutAttributeCenterX <span class="string">relatedBy:</span>NSLayoutRelationEqual <span class="string">toItem:</span>self.superview <span class="string">attribute:</span>NSLayoutAttributeCenterX <span class="string">multiplier:</span><span class="number">1</span> <span class="string">constant:</span><span class="number">0</span>]];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><em>太糟糕了</em>，它不能离开相对于它的父视图的位置。所以，当父视图想把Awesome放到另一个位置上会怎么样？是的，就会抛出来另一个<em>Unable to simultaneously satisfy constraints</em>的问题。</p>
<h4 id="updateConstraints是用来更新约束条件的"><a href="#updateConstraints是用来更新约束条件的" class="headerlink" title="updateConstraints是用来更新约束条件的"></a>updateConstraints是用来更新约束条件的</h4><p>顾名思义，<code>updateConstraints</code>只是被用来更新需要的约束的。一个正确的实现<code>updateConstraints</code>的方式应该长这个样子：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">instancetype</span>)init</div><div class="line">&#123;</div><div class="line"> …</div><div class="line"> init stuff</div><div class="line"> …</div><div class="line"> _labelCenterYConstraints = [<span class="built_in">NSLayoutConstraint</span> constraintWithItem:label attribute:<span class="built_in">NSLayoutAttributeCenterY</span> relatedBy:<span class="built_in">NSLayoutRelationEqual</span> toItem:<span class="keyword">self</span> attribute:<span class="built_in">NSLayoutAttributeCenterY</span> multiplier:<span class="number">1</span> constant:<span class="number">0</span>];</div><div class="line"> [<span class="keyword">self</span> addConstraint:_labelCenterYConstraints];</div><div class="line"> label.text = @”I Am truly awesome!”;</div><div class="line"> …</div><div class="line">&#125;</div><div class="line">- (<span class="keyword">void</span>)updateConstraints &#123;</div><div class="line">  <span class="keyword">self</span>.labelCenterYConstraints.constant = <span class="keyword">self</span>.labelVerticalDisplacement;</div><div class="line">  [<span class="keyword">super</span> updateConstraints];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后在需要的地方：<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">awesome.labelVerticalDisplacement = <span class="number">40</span><span class="comment">;</span></div><div class="line">[awesome setNeedsUpdateConstraints]<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>调用<code>setNeedsUpdateConstraints</code>会使autoLayout重新计算布局，因此会调用<em> updateConstraints</em>，从而读取新的label状态并更新约束。</p>
<p>在上面的例子中，你本可以只更新<em> _labelCenterYConstraints</em>这个约束，如果你的视图暴露出约束，或者如果你可以简单获得一个约束，那就直接设置约束的常量好了，不必使用<em>updateConstraints</em>。所以，上面的代码也可以这么实现：<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awesome.labelCenterYConstraints.constant = <span class="number">40</span><span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>一个<strong>非常糟糕</strong>的<em> updateConstraints</em>的实现会长这个样子：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)updateConstraints &#123;</div><div class="line">  [<span class="keyword">self</span> removeConstraints:<span class="keyword">self</span>.constraints];</div><div class="line">  <span class="comment">/*</span></div><div class="line">  create the constraint here</div><div class="line">  */</div><div class="line">  [<span class="keyword">super</span> updateConstraints];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这么做是非常错误的，因为：</p>
<ul>
<li>系统调用<em> updateConstraints</em>很多次，因此移除或者重新创建可能会校验约束的合理性。</li>
<li><code>[self removeConstraints:self.constraints]</code>; 会移除包括xib或storyboard创建的所有约束条件，你该怎么重新创建这些约束？（赶紧说你不能！）</li>
<li>上面的<em>updateConstraints</em>实现会覆盖掉<em>intrinsicContentSize</em>的效果，因为你在调用<code>[super updateConstraints];</code>后移除了系统添加的约束条件。</li>
<li><code>updateConstraints</code>应该被用来创建约束条件一次，然后仅仅移除掉失效的约束。它绝不该是一个移除所有约束再把每个传过来的布局添加上的地方。（感谢Alexis提供以下补充。）</li>
</ul>
<p>正确的实现方式是这样：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)updateConstraints &#123;</div><div class="line">  <span class="keyword">if</span> (!didSetConstraints) &#123;</div><div class="line"> didSetConstraints = <span class="literal">YES</span>;</div><div class="line">  <span class="comment">//create the constraint here</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//Update the constraints if needed</span></div><div class="line">  [<span class="keyword">super</span> updateConstraints];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在上面的代码中，创建约束的动作只会执行一次，然后在接下来的<em>updateConstraints</em>调用中，只会对这些已创建的约束的常量进行修改。</p>
<p>我一直在追寻真理！所以如果你有很多更好的实践经验，请在twitter上和我分享。</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/12/11/be-an-independent-explorer-not-a-lazy-coder/">Be an independent explorer, not a lazy coder</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-12-11
        </span></div>
    </header>

    <div class="post-content"><p>Here’s an SOF <a href="http://stackoverflow.com/a/18837736/1594792" title="http://stackoverflow.com/a/18837736/1594792" target="_blank" rel="external">answer</a> that makes me think.</p>
<p>Obviously, the asker required for the method of <em>simple code</em> of <a href="https://github.com/enormego/EGOCache" title="https://github.com/enormego/EGOCache" target="_blank" rel="external">EGOCache</a>  Library, since its responser didn’t provide any example or demo for it.</p>
<p>Two answers provided are very interesting. One gives line-by-line code —- who can refuse attractive and brief code? While the other one just tells you how to dive your head first and find out on your own.</p>
<p>It says as below.</p>
<blockquote>
<p>In the Objective-C world in a case like this when there isn’t as much documentation as I think there <em>should</em> be, I go straight to the header file. Then in your case I would look for a method named something like <code>setData</code> (I assumed this name even before I had read the header to answer this) which is here. Then you would use <code>dataForKey:</code> from here and finally <code>clearCache</code> from here so in short, yep your assumptions looked correct.</p>
<p>Give a man a fish, and you feed him for a day.</p>
</blockquote>
<p>It seems that we are gradually doted by the <em>Step-By-Step</em> tutorials and lose our independence to have a try. Of course, the tutorials are so friendly and helpful to fresh fish, meanwhile, they also make developers lazier.</p>
<p>In my aspect, developers are meant that you dare to explore spaces even unfamiliar to them, get down to issues, and grow up steadily even compared with yourself several days before. </p>
<p>Or else, you’re just a lazy coder.</p>

        </div></article>
      <nav class="pagination"><a class="prev" href="/page/7/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">Prev</span>
      </a>
    <a class="next" href="/page/9/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></section></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:calios_1124@163.com" class="iconfont icon-email" title="email"></a>
        <a href="http://github.com/caliosd" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2020<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Calios</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
