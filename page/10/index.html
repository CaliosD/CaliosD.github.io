<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="Stedfast as thou art."/><link rel="alternate" href="/atom.xml" title="Calios' Eden"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0" />
<link rel="canonical" href="http://www.caliosd.gq/page/10/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-71292392-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-71292392-1');
</script><script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":false};
</script>

    <title>Calios' Eden</title>
  <link rel="alternate" href="/atom.xml" title="Calios' Eden" type="application/atom+xml">
</head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Calios' Eden</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Calios' Eden</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><section id="posts" class="posts"><article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/11/13/how-not-to-crash-2-mutation-exceptions/">【译】如何避免程序崩溃-2：可变对象的异常</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-11-13
        </span></div>
    </header>

    <div class="post-content"><p>原文链接：<a href="http://inessential.com/2015/05/16/how_not_to_crash_2_mutation_exceptions" target="_blank" rel="external">http://inessential.com/2015/05/16/how_not_to_crash_2_mutation_exceptions</a></p>
<hr>
<p>你从某处获取到一个集合并枚举它 —— 然后当你在改变这个集合的时候报错，因为它正在进行枚举。应用崩溃了。</p>
<p>你可以通过一个小技巧避免这种悲伤的命运：不要对可变的集合进行枚举操作。</p>
<h4 id="异议"><a href="#异议" class="headerlink" title="异议"></a>异议</h4><p>你可能持有某种合理的观点，说<em>真正</em>的答案是不要在对集合进行枚举的时候对可变的集合进行改变。你应该对于自己的应用有足够的了解，以便能够写出安全地对可变集合进行枚举的代码。</p>
<p>是的，你应该如此。你绝对应该如此。</p>
<p>然而：编写远离崩溃的代码就是在于消除疑点。就在于能够将错误的几率最小化，将未来的（由你或其他人带来的）改变引入崩溃的可能性最小化。</p>
<h4 id="可变集合不应该成为公有接口的一部分"><a href="#可变集合不应该成为公有接口的一部分" class="headerlink" title="可变集合不应该成为公有接口的一部分"></a>可变集合不应该成为公有接口的一部分</h4><p>一个对象拥有一个可变集合作为公有属性，这件事本来就应该尽量避免 —— 或者最好不要发生。可变集合应该被控制在对象内部。</p>
<p>（更进一步地说，公有的集合应该为只读。当然事实也并非总是如此。）</p>
<p>现在，它整体上可能是有一个公有集合，在内部又有一个可变的集合。想象一个跟踪operation的对象。它可能公有方法这么写：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">property</span><span class="title"> </span>(nonatomic, readonly) NSArray *<span class="keyword">operations</span>;</div></pre></td></tr></table></figure></p>
<p>内部私有方法这么写：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSMutableArray</span> *mutableOperations;</div><div class="line">- (<span class="built_in">NSArray</span> *)operations &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">self</span>.mutableOperations;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这是完全合情合理的代码：因为mutableOperations是一个NSMutableArray，它又同时是一个NSArray。（我多年来都这么写。我对自己说：”Hey，我是个过来人了。我能<em>应付的了</em>。“但是我没有意识到的是，成熟的开发者是为了减少出错的可能而写代码。）</p>
<h4 id="被指定为不可变的属性应该名副其实"><a href="#被指定为不可变的属性应该名副其实" class="headerlink" title="被指定为不可变的属性应该名副其实"></a>被指定为不可变的属性应该名副其实</h4><p>在上面的例子中，你声明<code>operations</code>是一个在任何时候都可以安全枚举的数组。另一个人 —— 或者就是你自己 —— 在六个月之后看这段代码时，完全不会意识到你正在获取的可变数组，并<em>不能</em>足够安全地进行枚举。</p>
<p>这就是实现名副其实的解决方案：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSArray</span> *)operations &#123;</div><div class="line">  <span class="keyword">return</span> [<span class="keyword">self</span>.mutableOperations <span class="keyword">copy</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>（如果为了表达得更清晰，把属性声明为copy也不会有影响，但是我承认我不经常这么做。让API的使用者完全清晰地知道正在发生什么应该是有好处的。）</p>
<p>你可能会翻回去引用性能或者内存使用的问题或者二者皆有 —— 而我必须承认：我是一个性能的推崇者，我会在Instruments上花费超乎常理的时间，仅为了能够让代码快速运行、没有不合理的内存消耗。我从来没有发现这么做有任何问题。如果你的应用出现性能或者内存消耗的问题，可能是其他问题导致的，而不是这些copy。（尽管你可以考虑使用<code>@autoreleasepool</code>来让这些copy不留存那么长时间。）</p>
<p>copy一下吧。</p>
<h4 id="彩蛋：不要相信他们的谎言"><a href="#彩蛋：不要相信他们的谎言" class="headerlink" title="彩蛋：不要相信他们的谎言"></a>彩蛋：不要相信他们的谎言</h4><p>我最近解决了一个在枚举NSTextStorage layoutManager时可变量的问题：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSArray</span> *layoutManagers;</div></pre></td></tr></table></figure></p>
<p><em>显然</em> 枚举是安全的。它是一个NSArray，它声明自己是个copy。漂亮。枚举走起。</p>
<p>但是，它骗我。在调试器里，我发现它是一个NSMutableArray（__NSArrayM）—— 而且它根本就不是一个copy。它是NSTextStorage的名为<code>_layoutManagers</code>的实例变量，这个变量被声明为一个NSMutableArray。</p>
<p>而在我的枚举的block代码里面，触发了layoutManagers的改变，然后应用就崩溃了。</p>
<p>答案是：对layoutManagers的副本进行枚举。问题就解决了。</p>
<p>常言道：如果你从别人的代码中获取一个集合，对副本进行枚举总没坏处，防患于未然嘛。</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/11/12/how-not-to-crash-1-kvo-and-manual-bind/">【译】如何避免程序崩溃-1：KVO与手动绑定</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-11-12
        </span></div>
    </header>

    <div class="post-content"><p>原文链接：<a href="http://inessential.com/2015/05/14/how_not_to_crash_1_kvo_and_manual_bind" title="http://inessential.com/2015/05/14/how_not_to_crash_1_kvo_and_manual_bind" target="_blank" rel="external">http://inessential.com/2015/05/14/how_not_to_crash_1_kvo_and_manual_bind</a></p>
<hr>
<p>我最近在修复系统崩溃的bug —— 但是，与写如何修复bug相比，我想，写写如何在最初就避免创造崩溃的bug会更有意思一些。</p>
<p>在第一部分，我会谈谈KVO，手动绑定，引用循环和无效方法。</p>
<h4 id="绑定意味着永远不会失联"><a href="#绑定意味着永远不会失联" class="headerlink" title="绑定意味着永远不会失联"></a>绑定意味着永远不会失联</h4><p>iOS开发者没有这个，但是Mac开发者的小伙伴们有：我们可以把一个属性绑定在另一个属性上。我们可以实现这点，即当x.foo更新的时候，y.foo也随之更新。</p>
<p>NSKeyValueBinding.h在AppKit中。我们来看下<code>bind:toObject:withKeyPath:options:</code>.</p>
<p>假设有一个有着title属性的button。每当controller的title更新的时候，这个title属性也应该随之更新。我们假设controller拥有这个button。你可以这样写代码：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> NSString kTitleKey = @<span class="string">"title"</span>;</div><div class="line">[self.button <span class="string">bind:</span>kTitleKey <span class="string">toObject:</span>self <span class="string">withKeyPath:</span>kTitleKey <span class="string">options:</span>nil];</div></pre></td></tr></table></figure></p>
<p>非常方便，而且很有效。</p>
<p>同时，你也离崩溃不远了。</p>
<p>问题在于：这个绑定引用了<code>toObject</code>。这就意味着这个button有效地引用了controller。如果controller又引用它的button（它本该如此），那么就造成了引用循环。二者都不会成为僵尸，但是都会被废弃。</p>
<p>一种崩溃的方式 —— 这也是真实场景 —— 是如果这个被废弃的controller监听着一个通知（我们称之为BSNotification），并且当接收到BSNotification的时候<em>做了点事</em>，当它<em>做这点事</em>的时候它就会崩溃，因为它在理论上已经失效，而它不知道该怎么处理这种情况。</p>
<h4 id="KVO意味着必须每次都把每件事做到完全正确"><a href="#KVO意味着必须每次都把每件事做到完全正确" class="headerlink" title="KVO意味着必须每次都把每件事做到完全正确"></a>KVO意味着必须每次都把每件事做到完全正确</h4><p>让我们加上第三个对象，一个model。我们<em>真正</em>想要的是这样的流程：<br>modelObject.title的更新，会使controller.title更新，而controller.title的更新，会使button.title更新。</p>
<p>这次我们来用KVO。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">- (<span class="built_in">NSString</span> *)title &#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">self</span>.modelObject.title;</div><div class="line">&#125;</div><div class="line">+ (<span class="built_in">NSSet</span> *)keyPaths​ForValues​AffectingTitle &#123;</div><div class="line">  <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithObject:​<span class="string">@"modelObject.title"</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>好了 —— 现在我们有了完整的流程。当modelObject.title改变的时候，会影响controller.title，同时button.title也随之更新为正确的值。</p>
<p>非常方便，而且很有效。</p>
<p>当然，它会崩溃，在modelObject被释放的时候（因为modelObject的实例在它还是一个观察者的时候被释放了）。</p>
<p>如果反过来，controller引用modelObject（它可能应该如此），然后你就有了一个被废弃的第三个对象，它永远不会被释放，是个随着时间变化不断增长变大的讨厌家伙。</p>
<h4 id="一个并不那么漂亮的解决办法"><a href="#一个并不那么漂亮的解决办法" class="headerlink" title="一个并不那么漂亮的解决办法"></a>一个并不那么漂亮的解决办法</h4><p>controller可以有一个类似于<code>invalidate</code>这样名字的函数，用来打破引用循环。一旦打破，<code>dealloc</code>方法就会因为controller、它的button和它的model对象而被调用。</p>
<p>你可以这么写代码，以便在你知道你用完了controller的时候调用：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-(<span class="keyword">void</span>)invalidate &#123;</div><div class="line">  [<span class="keyword">self</span>.button unbind:kTitleKey];</div><div class="line">  <span class="keyword">self</span>.modelObject = <span class="literal">nil</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这就是这个解决办法不那么漂亮的地方：</p>
<p>引用计数是非常棒的解决方案 —— 它能保证在<code>dealloc</code>被调用的时候，没有哪个对象拥有对于这个即将释放的对象的强引用。这就使得<code>dealloc</code>成为一个移除观察者及其他类似需要移除的不错地点。</p>
<p>但是如果你使用了类似invalidate的函数，你就是在试图自己来接手引用计数这件事。你<em>不得不</em>调用invalidate，又不得不在<em>合适的</em>时候调用。你能对每一个拥有invalidate函数的对象做出永久的保证么？如果出现一些改变，不只有一个对象引用了controller，你该怎么办？谁来调用invalidate？什么时候调用？</p>
<p>那是一大堆额外需要考虑的工作，而编程的目的之一就是使错误尽可能的减少。依赖invalidate会使错误出现的可能<em>大大增加</em>。</p>
<h4 id="一个更好的解决办法"><a href="#一个更好的解决办法" class="headerlink" title="一个更好的解决办法"></a>一个更好的解决办法</h4><p>让我们回归到我们试图解决的问题上来：</p>
<p>modelObject.title的更新，会使controller.title更新，而controller.title的更新，会使button.title更新。</p>
<p>简而言之：controller知道modelObject和button，但是后两者之间并不知道彼此的存在，也不知道controller的存在。这就是我们怎么避开invalidate函数来解决问题。</p>
<p>在controller中，灭掉自定义getter。灭掉<code>keyPathsForValuesAffectingTitle</code>.灭掉<code>bind: toObject: withKeyPath: options:</code>的使用。</p>
<p>取而代之的是，创建自定义的setter —— 因为，无论如何，setter在改变的时候总是会被调用，所有需要解决的问题就是广播title属性的更新。<br><figure class="highlight xl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-(void)setTitle:(NSString *)<span class="built_in">title</span> &#123;</div><div class="line">  _<span class="built_in">title</span> = <span class="built_in">title</span>;</div><div class="line">  self.button.<span class="built_in">title</span> = <span class="built_in">title</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>问题解决了一半：当controller.title改变时，button.title也随之改变。</p>
<p>我们不能对modelObject做同样的事情，因为它不知道controller的存在。所以反过来，让controller来观察modelObject.title。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[self.modelObject <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span> kTitleKey <span class="string">options:</span><span class="number">0</span> <span class="string">context:</span> kTitleContext];</div></pre></td></tr></table></figure></p>
<p>然后在KVO的观察函数里，监测kTitleContext，然后让<code>self.title = self.modelObject.title</code>。这会调用controller的<code>setTitle:</code>函数 —— 而该函数会更新button.title。</p>
<p>这个解决办法就不会存在引用循环的问题。还有一点移除的工作要做，但你可以在controller的<code>dealloc</code>函数中用一行代码了结：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[_modelObject <span class="string">removeObserver:</span> self <span class="string">forKeyPath:</span>kTitleKey <span class="string">context:</span> kTitleContext];</div></pre></td></tr></table></figure></p>
<h4 id="总结与建议"><a href="#总结与建议" class="headerlink" title="总结与建议"></a>总结与建议</h4><p>我们提出的解决方案避免了引用循环，不必时刻记得要调用invalidate函数，也不用担心调用的时机是否正确。这是更安全的代码。</p>
<p>更棒的是，它用了更少的代码，而且足够简洁。</p>
<p>一些建议：</p>
<ul>
<li>不要在任何场景中使用<code>bind: toObject: withKeyPath: options:</code>(iOS的小伙伴们：你们应该高兴自己没有这样的选择。也可以把它当做可能它之所以为Mac开发而非iOS的原因之一)。</li>
<li>当你广播数据更新时，用自定义的setter，而不是自定义getter（毕竟是在<em>setter</em>中更新的数据）。</li>
<li>避免invalidate这样的函数，尽量让引用计数做它自己的事情 —— 因为如果<em>你</em>是那个跟踪计数的角色，你多半会出错。（我发现我不是总能够避免invalidate这样的函数，但是可能性总是比你想的要多那么一点）</li>
<li>在思考你的应用中发生了什么时，任何形式的观察死锁都会带来困难：在任何时候它有足够理由出现时，都最好是准确的。一旦你有了足够多的这种藤蔓般无处不在的观察模式，你就建造了一个不见天日的丛林，对它的每一点改变都会让你如履薄冰。</li>
<li>理论上，绑定和KVO是为了解耦而生的，而实际上这种耦合就是那么紧密 —— 在某种程度上，如果没有更紧密的话 —— 更难debug，更难矫正。通常情况下，最好把观察模式明确写清（不要写成<code>keyPathsForValuesAffectingXyz</code>这种），避免在keyPath中出现”.”字符。</li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/11/12/how-not-to-crash-0-catalog/">【译】如何避免程序崩溃-0：目录</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-11-12
        </span></div>
    </header>

    <div class="post-content"><p>原文索引：</p>
<p><a href="http://inessential.com/2015/05/14/how_not_to_crash_1_kvo_and_manual_bind" title="http://inessential.com/2015/05/14/how_not_to_crash_1_kvo_and_manual_bind" target="_blank" rel="external">#1: KVO与手动绑定</a><br><a href="http://inessential.com/2015/05/16/how_not_to_crash_2_mutation_exceptions" title="http://inessential.com/2015/05/16/how_not_to_crash_2_mutation_exceptions" target="_blank" rel="external">#2: 可变对象的异常</a><br><a href="http://inessential.com/2015/05/21/how_not_to_crash_3_nsnotification" title="http://inessential.com/2015/05/21/how_not_to_crash_3_nsnotification" target="_blank" rel="external">#3: NSNotification</a><br><a href="http://inessential.com/2015/05/22/how_not_to_crash_4_threading" title="http://inessential.com/2015/05/22/how_not_to_crash_4_threading" target="_blank" rel="external">#4: 线程</a><br><a href="http://inessential.com/2015/05/26/how_not_to_crash_5_threading_part_2" title="http://inessential.com/2015/05/26/how_not_to_crash_5_threading_part_2" target="_blank" rel="external">#5: 线程2</a><br><a href="http://inessential.com/2015/05/27/how_not_to_crash_6_properties_and_acce" title="http://inessential.com/2015/05/27/how_not_to_crash_6_properties_and_acce" target="_blank" rel="external">#6: 属性和存取器</a><br><a href="http://inessential.com/2015/05/29/how_not_to_crash_7_dealing_with_nothin" title="http://inessential.com/2015/05/29/how_not_to_crash_7_dealing_with_nothin" target="_blank" rel="external">#7: 什么都不做</a><br><a href="http://inessential.com/2015/06/10/how_not_to_crash_8_infrastructure" title="http://inessential.com/2015/06/10/how_not_to_crash_8_infrastructure" target="_blank" rel="external">#8: 基本架构</a><br><a href="http://inessential.com/2015/06/10/how_not_to_crash_9_mindset" title="http://inessential.com/2015/06/10/how_not_to_crash_9_mindset" target="_blank" rel="external">#9: 心态</a></p>
<hr>
<p>译文索引：</p>
<p><a href="http://www.caliosd.gq/2015/11/12/how-not-to-crash-1-kvo-and-manual-bind/" title="http://www.caliosd.gq/2015/11/12/how-not-to-crash-1-kvo-and-manual-bind/">#1: KVO与手动绑定</a><br><a href="http://www.caliosd.gq/2015/11/13/how-not-to-crash-2-mutation-exceptions/" title="http://www.caliosd.gq/2015/11/13/how-not-to-crash-2-mutation-exceptions/">#2: 可变对象的异常</a><br><a href="http://www.caliosd.gq/2015/11/16/how-not-to-crash-3-nsnotification/" title="http://www.caliosd.gq/2015/11/16/how-not-to-crash-3-nsnotification/">#3: NSNotification</a><br><a href="http://www.caliosd.gq/2015/11/19/how-not-to-crash-4-threading/" title="http://www.caliosd.gq/2015/11/19/how-not-to-crash-4-threading/">#4: 线程</a><br><a href="http://www.caliosd.gq/2015/11/26/how-not-to-crash-5-threading-part-2/" title="http://www.caliosd.gq/2015/11/26/how-not-to-crash-5-threading-part-2/">#5: 线程2</a><br><a href="http://www.caliosd.gq/2015/11/26/how-not-to-crash-6-properties-and-accessories/" title="http://www.caliosd.gq/2015/11/26/how-not-to-crash-6-properties-and-accessories/">#6: 属性和存取器</a><br><a href="http://www.caliosd.gq/2015/12/19/how-not-to-crash-7-dealing-with-nothing/" title="http://www.caliosd.gq/2015/12/19/how-not-to-crash-7-dealing-with-nothing/">#7: 什么都不做</a><br><a href="http://www.caliosd.gq/2016/01/21/how-not-to-crash-8-infrastructure/" title="http://www.caliosd.gq/2016/01/21/how-not-to-crash-8-infrastructure/">#8: 基本架构</a><br><a href="http://www.caliosd.gq/2016/02/24/how-not-to-crash-9-mindset/" title="http://www.caliosd.gq/2016/02/24/how-not-to-crash-9-mindset/">#9: 心态</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/09/25/install-MongoDB-in-OS-X/">OS X安装MongoDB</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-09-25
        </span></div>
    </header>

    <div class="post-content"><p>在OS X中，使用<a href="http://brew.sh/" target="_blank" rel="external">Homebrew</a>完成各种package的安装工作无疑是很方便的。如下是使用Homebrew安装MongoDB的步骤。</p>
<h4 id="1-更新Homebrew的package数据库"><a href="#1-更新Homebrew的package数据库" class="headerlink" title="1.更新Homebrew的package数据库"></a>1.更新Homebrew的package数据库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> brew update</span></div></pre></td></tr></table></figure>
<h4 id="2-安装MongoDB"><a href="#2-安装MongoDB" class="headerlink" title="2.安装MongoDB"></a>2.安装MongoDB</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$ brew install mongodb</div><div class="line">==\&gt; Downloading https:<span class="comment">//homebrew.bintray.com/bottles/mongodb-3.0.6.yosemite.bottle.tar.gz</span></div><div class="line">###### \#\#########                                                          <span class="number">23.0</span>%</div><div class="line">curl: (<span class="number">56</span>) SSLRead() return error <span class="number">-9806</span></div><div class="line">Error: Failed to download resource <span class="string">"mongodb"</span></div><div class="line">Download failed: https:<span class="comment">//homebrew.bintray.com/bottles/mongodb-3.0.6.yosemite.bottle.tar.gz</span></div><div class="line">Warning: Bottle installation failed: building <span class="keyword">from</span> source.</div><div class="line">==\&gt; Downloading https:<span class="comment">//fastdl.mongodb.org/src/mongodb-src-r3.0.6.tar.gz</span></div><div class="line">###### \#\################################################################# <span class="number">100.0</span>%</div><div class="line">==\&gt; Cloning https:<span class="comment">//github.com/mongodb/mongo-tools.git</span></div><div class="line">Cloning into <span class="string">'/Library/Caches/Homebrew/mongodb--github.com-mongodb-mongo-tools--git'</span>...</div><div class="line">remote: Counting objects: <span class="number">1180</span>, done.</div><div class="line">remote: Compressing objects: <span class="number">100</span>% (<span class="number">950</span>/<span class="number">950</span>), done.</div><div class="line">remote: Total <span class="number">1180</span> (delta <span class="number">184</span>), reused <span class="number">840</span> (delta <span class="number">136</span>), pack-reused <span class="number">0</span></div><div class="line">Receiving objects: <span class="number">100</span>% (<span class="number">1180</span>/<span class="number">1180</span>), <span class="number">1.86</span> MiB | <span class="number">230.00</span> KiB/s, done.</div><div class="line">Resolving deltas: <span class="number">100</span>% (<span class="number">184</span>/<span class="number">184</span>), done.</div><div class="line">Checking connectivity... done.</div><div class="line">Note: checking out <span class="string">'7588eb887549bd5d2fc7bbc08f7c62d4b29b9d75'</span>.</div></pre></td></tr></table></figure>
<p>You are in ‘detached HEAD’ state. You can look around, make experimental<br>changes and commit them, and you can discard any commits you make in this<br>state without impacting any branches by performing another checkout.</p>
<p>If you want to create a new branch to retain commits you create, you may<br>do so (now or later) by using -b with the checkout command again. Example:<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">  git checkout -b new\_branch\_name</div><div class="line"></div><div class="line">=<span class="ruby">=&gt; Checking out tag r3.<span class="number">0</span>.<span class="number">6</span></span></div><div class="line">=<span class="ruby">=&gt; ./build.sh</span></div><div class="line">=<span class="ruby">=&gt; /usr/local/opt/scons/bin/scons install --prefix=<span class="regexp">/usr/local</span><span class="regexp">/Cellar/mongodb</span><span class="regexp">/3.0.6 -j8 --osx-version-min=10.10 --cc=</span></span></div><div class="line">=<span class="ruby"><span class="regexp">=&gt; Caveats</span></span></div><div class="line">To have launchd start mongodb at login:</div><div class="line">  ln -sfv /usr/local/opt/mongodb/\*.plist \~/Library/LaunchAgents</div><div class="line">Then to load mongodb now:</div><div class="line">  launchctl load \~/Library/LaunchAgents/homebrew.mxcl.mongodb.plist</div><div class="line">Or, if you don't want/need launchctl, you can just run:</div><div class="line">  mongod --config /usr/local/etc/mongod.conf</div><div class="line">=<span class="ruby"><span class="regexp">=&gt; Summary</span></span></div><div class="line">🍺  /usr/local/Cellar/mongodb/3.0.6: 17 files, 158M, built in 7.2 minutes</div></pre></td></tr></table></figure></p>
<p>看起来通过Homebrew的bottle来安装失败，于是开始下载源代码来编译，最终安装成功。</p>
<h4 id="3-启动MongoDB"><a href="#3-启动MongoDB" class="headerlink" title="3.启动MongoDB"></a>3.启动MongoDB</h4><p>按照Terminal中的提示，直接启动MongoDB。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> mongod --config /usr/<span class="built_in">local</span>/etc/mongod.conf</span></div></pre></td></tr></table></figure>
<p>通过Terminal直接连接MongoDB。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> mongo</span></div><div class="line">MongoDB shell version: 3.0.6</div><div class="line">connecting to: test</div><div class="line"><span class="meta">&gt;</span><span class="bash"></span></div></pre></td></tr></table></figure>
<hr>
<p><strong>Ref:</strong></p>
<p><a href="http://docs.mongodb.org/manual/tutorial/install-mongodb-on-os-x/" target="_blank" rel="external">http://docs.mongodb.org/manual/tutorial/install-mongodb-on-os-x/</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/09/24/AVPlayer-class-reference/">AVPlayer Class Reference</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-09-24
        </span></div>
    </header>

    <div class="post-content"><h4 id="1-Create-a-Player"><a href="#1-Create-a-Player" class="headerlink" title="1.Create a Player"></a>1.Create a Player</h4><ul>
<li><p>With a url: </p>
<ul>
<li>implicitly create an <code>AVPlayerItem</code> object. Getting it by <code>currentItem</code>.</li>
</ul>
</li>
<li><p>With a player item: </p>
<ul>
<li>used to play items for which an <code>AVAsset</code> object has previously been created.</li>
</ul>
</li>
</ul>
<h4 id="2-Managing-Playback"><a href="#2-Managing-Playback" class="headerlink" title="2.Managing Playback"></a>2.Managing Playback</h4><ul>
<li><p>play: </p>
<ul>
<li>same as setting <code>rate</code> to <code>1.0</code>.</li>
</ul>
</li>
<li><p>pause:</p>
<ul>
<li>same as setting <code>rate</code> to <code>0.0</code>.</li>
</ul>
</li>
<li><p>rate: </p>
<ul>
<li>other than <code>0.0</code> and <code>1.0</code>, rate can be used if the associated player item returns <code>YES</code> for the <code>AVPlayerItem</code> properties<code>canPlaySlowForward</code> or <code>canPlayFastForward</code>.</li>
</ul>
</li>
<li><p>actionAtItemEnd：</p>
<ul>
<li><code>AVPlayerActionAtItemEndAdvance</code>: only for <code>AVQueuePlayer</code></li>
<li><code>AVPlayerActionAtItemEndPause</code>: default </li>
<li><code>AVPlayerActionAtItemEndNone</code>: let it be free. :P</li>
</ul>
</li>
<li><p>replaceCurrentItemWithPlayerItem: </p>
<ul>
<li>only for player instances without queues. </li>
<li>Use key-value observing to observe the currentItem property for changes.</li>
<li><u>Well, what does it means by ‘The new item must have the same compositor as the item it replaces, or have no compositor.’ ?</u></li>
</ul>
</li>
<li><p>prerollAtRate:completionHandler:</p>
<ul>
<li>loads data starting at the item’s current playback time.</li>
<li>only be set when <code>status</code> of player is <code>AVPlayerStatusReadyToPlay</code>, otherwise an exception is thown.</li>
</ul>
</li>
<li><p>cancelPendingPrerolls: </p>
<ul>
<li>cancels any pending operations to prepare the render pipeline for the current item.</li>
</ul>
</li>
</ul>
<h4 id="3-Managing-Time"><a href="#3-Managing-Time" class="headerlink" title="3.Managing Time"></a>3.Managing Time</h4><ul>
<li><p>currentTime: </p>
<ul>
<li><code>CMTime</code>,  <code>CoreMediaFramework</code></li>
<li>not key-value observable.</li>
<li>use <code>addPeriodicTimeObserverForInterval:queue:usingBlock:</code> or <code>addBoundaryTimeObserverForTimes:queue:usingBlock:</code> instead.</li>
</ul>
</li>
<li><p>seekToTime:completionHandler::</p>
<ul>
<li>Moves the playback cursor and executes the specified block when the seek operation has either been completed or been interrupted.</li>
</ul>
</li>
<li><p>other <code>seek</code> functions: nearly the same.</p>
</li>
</ul>
<h4 id="4-Managing-External-Playback-abbr"><a href="#4-Managing-External-Playback-abbr" class="headerlink" title="4.Managing External Playback (abbr.)"></a>4.Managing External Playback (abbr.)</h4><h4 id="5-Synchronizing-Playback-to-an-External-Source-abbr"><a href="#5-Synchronizing-Playback-to-an-External-Source-abbr" class="headerlink" title="5.Synchronizing Playback to an External Source (abbr.)"></a>5.Synchronizing Playback to an External Source (abbr.)</h4><h4 id="6-Timed-Observations"><a href="#6-Timed-Observations" class="headerlink" title="6.Timed Observations"></a>6.Timed Observations</h4><ul>
<li><p><strong>addPeriodicTimeObserverForInterval:queue:usingBlock:</strong></p>
<ul>
<li>requests invocation of a given block during playback to report changing time.</li>
<li><u>** You must retain the returned value as long as you want the time observer to be invoked by the player. Each invocation of this method should be paired with a corresponding call to <code>removeTimeObserver:</code>.**</u></li>
<li><strong>Attention:</strong> Releasing the observer object without invoking <code>removeTimeObserver:</code> will result in undefined behavior.</li>
</ul>
</li>
<li><p>addBoundaryTimeObserverForTimes:queue:usingBlock: (abbr.)</p>
</li>
<li><strong>removeTimeObserver:</strong><ul>
<li>Upon return, the caller is guaranteed that no new time observer blocks will begin executing. Depending on the calling thread and the queue used to add the time observer, an in-flight block may continue to execute after this method returns. You can guarantee synchronous time observer removal by enqueuing the call to <code>removeTimeObserver</code> on that queue. Alternatively, call <code>dispatch_sync(queue, ^{})</code> after <code>removeTimeObserver</code> to wait for any in-flight blocks to finish executing.</li>
</ul>
</li>
</ul>
<h4 id="7-Managing-Closed-Caption-Display"><a href="#7-Managing-Closed-Caption-Display" class="headerlink" title="7.Managing Closed Caption Display"></a>7.Managing Closed Caption Display</h4><ul>
<li>closedCaptionDisplayEnabled:<ul>
<li>Indicates whether the player uses closed captioning.</li>
</ul>
</li>
</ul>
<h4 id="8-Managing-Audio-Output"><a href="#8-Managing-Audio-Output" class="headerlink" title="8.Managing Audio Output"></a>8.Managing Audio Output</h4><ul>
<li>muted:<ul>
<li>Indicates whether the audio output of the player is muted.</li>
</ul>
</li>
<li><strong>volume:</strong><ul>
<li>audio playback volume for the player, ranging from 0.0 through 1.0 on a linear scale.</li>
<li>To provide UI in iOS for adjusting system audio playback volume, use the <code>MPVolumeView</code> class, which provides media playback controls that iOS users expect and whose appearance you can customize.</li>
</ul>
</li>
</ul>
<h4 id="9-Player-Properties"><a href="#9-Player-Properties" class="headerlink" title="9.Player Properties"></a>9.Player Properties</h4><ul>
<li>status:<ul>
<li>Indicates whether the player can be used for playback. (read-only)</li>
<li>When the value of this property is <code>AVPlayerStatusFailed</code>, you can no longer use the player for playback and you need to create a new instance to replace it. If this happens, you can check the value of the error property to determine the nature of the failure.</li>
<li>This property is key value observable using <code>Key-value observing</code>.</li>
</ul>
</li>
<li>error:<ul>
<li>If the receiver’s status is AVPlayerStatusFailed, this describes the error that caused the failure. (read-only)</li>
</ul>
</li>
<li>currentItem:<ul>
<li>The player’s current item. (read-only)</li>
</ul>
</li>
<li>outputObscuredDueToInsufficientExternalProtection (abbr.)</li>
</ul>
<h4 id="10-Media-Selection-Criteria-Settings-abbr"><a href="#10-Media-Selection-Criteria-Settings-abbr" class="headerlink" title="10.Media Selection Criteria Settings (abbr.)"></a>10.Media Selection Criteria Settings (abbr.)</h4><h4 id="11-Constants"><a href="#11-Constants" class="headerlink" title="11.Constants"></a>11.Constants</h4><ul>
<li><p>AVPlayerStatus:</p>
<ul>
<li>Possible values of the status property, to indicate whether it can successfully play items.</li>
</ul>
</li>
<li><p>AVPlayerActionAtItemEnd (abbr.)</p>
</li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/09/18/lsof-usage/">lsof——Mac查看端口占用情况</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-09-18
        </span></div>
    </header>

    <div class="post-content"><h4 id="Issue"><a href="#Issue" class="headerlink" title="Issue"></a>Issue</h4><p>在本地通过Node.js起了一个服务来监听3000端口，在Terminal执行<code>node index.js</code> 后对该文件进行修改，而后<strong>直接</strong>再次执行<code>node index.js</code>。报如下错误：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="string">Gulugulu:</span>myapp calios$ node index.js</div><div class="line">events.<span class="string">js:</span><span class="number">85</span></div><div class="line">	  <span class="keyword">throw</span> er; <span class="comment">// Unhandled 'error' event</span></div><div class="line">	        ^</div><div class="line"><span class="string">Error:</span> listen EADDRINUSE</div><div class="line">	at exports._errnoException (util.<span class="string">js:</span><span class="number">746</span>:<span class="number">11</span>)</div><div class="line">	at Server._listen2 (net.<span class="string">js:</span><span class="number">1156</span>:<span class="number">14</span>)</div><div class="line">	at listen (net.<span class="string">js:</span><span class="number">1182</span>:<span class="number">10</span>)</div><div class="line">	at Server.listen (net.<span class="string">js:</span><span class="number">1267</span>:<span class="number">5</span>)</div><div class="line">	at EventEmitter.listen (<span class="regexp">/Users/</span>calios<span class="regexp">/Documents/</span>MyWorkspace<span class="regexp">/Front/</span>Node<span class="regexp">/myapp/</span>node_modules<span class="regexp">/express/</span>lib/application.<span class="string">js:</span><span class="number">617</span>:<span class="number">24</span>)</div><div class="line">	at Object.&lt;anonymous&gt; (<span class="regexp">/Users/</span>calios<span class="regexp">/Documents/</span>MyWorkspace<span class="regexp">/Front/</span>Node<span class="regexp">/myapp/</span>index.<span class="string">js:</span><span class="number">10</span>:<span class="number">18</span>)</div><div class="line">	at Module._compile (module.<span class="string">js:</span><span class="number">460</span>:<span class="number">26</span>)</div><div class="line">	at Object.Module._extensions..js (module.<span class="string">js:</span><span class="number">478</span>:<span class="number">10</span>)</div><div class="line">	at Module.load (module.<span class="string">js:</span><span class="number">355</span>:<span class="number">32</span>)</div><div class="line">	at Function.Module._load (module.<span class="string">js:</span><span class="number">310</span>:<span class="number">12</span>)</div></pre></td></tr></table></figure>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>首先查看<code>3000</code>端口是否已被占用。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ lsof -i :3000 (3000可替换为其他想查看的端口号)</div><div class="line">COMMAND   PID  <span class="built_in"> USER </span>  FD  <span class="built_in"> TYPE </span>            DEVICE SIZE/OFF NODE NAME</div><div class="line">node    48002 calios   14u <span class="built_in"> IPv6 </span>0x9534c78c493eedc3      0t0  TCP \*:hbci (LISTEN)</div></pre></td></tr></table></figure>
<p>发现正是刚才node起来的服务正在占用，kill掉这个<code>PID</code>为<code>48002</code>的家伙。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">kill</span> -9 48002</span></div></pre></td></tr></table></figure>
<p>此时再执行<code>node index.js</code>就不会报错了。</p>
<h4 id="More"><a href="#More" class="headerlink" title="More"></a>More</h4><h5 id="lsof-list-open-files"><a href="#lsof-list-open-files" class="headerlink" title="lsof(list open files)"></a>lsof(list open files)</h5><blockquote>
<p>Lsof lists on its standard output file information about files opened by processes.</p>
<p>An open file may be a regular file, a directory, a block special file, a character special  file,  an executing  text  reference,  a library, a stream or a network file (Internet socket, NFS file or UNIX domain socket.)  A specific file or all the files in a file system may be selected by path.</p>
<p>-i [i]  selects the listing of files any of whose Internet address matches the address specified  in i.   If  no  address  is specified, this option selects the listing of all Internet and x.25(HP-UX) network files.<br> [46][protocol][@hostname|hostaddr][:service|port]</p>
</blockquote>
<p>And here’s some functional commands.</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">lsof `which httpd`           <span class="comment">//那个进程在使用apache的可执行文件</span></div><div class="line">lsof /etc/passwd             <span class="comment">//那个进程在占用/etc/passwd</span></div><div class="line">lsof /dev/hda6               <span class="comment">//那个进程在占用hda6</span></div><div class="line">lsof /dev/cdrom              <span class="comment">//那个进程在占用光驱</span></div><div class="line">lsof -c sendmail             <span class="comment">//查看sendmail进程的文件使用情况</span></div><div class="line">lsof -c courier -u ^zahn     <span class="comment">//显示出那些文件被以courier打头的进程打开，但是并不属于用户zahn</span></div><div class="line">lsof -<span class="selector-tag">p</span> <span class="number">30297</span>                <span class="comment">//显示那些文件被pid为30297的进程打开</span></div><div class="line">lsof -D /tmp                 <span class="comment">//显示所有在/tmp文件夹中打开的instance和文件的进程。但是symbol文件并不在列</span></div><div class="line"></div><div class="line">lsof -u1000                  <span class="comment">//查看uid是100的用户的进程的文件使用情况</span></div><div class="line">lsof -utony                  <span class="comment">//查看用户tony的进程的文件使用情况</span></div><div class="line">lsof -u^tony                 <span class="comment">//查看不是用户tony的进程的文件使用情况(^是取反的意思)</span></div><div class="line">lsof -<span class="selector-tag">i</span>                      <span class="comment">//显示所有打开的端口</span></div><div class="line">lsof -<span class="selector-tag">i</span>:<span class="number">80</span>                   <span class="comment">//显示所有打开80端口的进程</span></div><div class="line">lsof -<span class="selector-tag">i</span> -U                   <span class="comment">//显示所有打开的端口和UNIX domain文件</span></div><div class="line">lsof -<span class="selector-tag">i</span> UDP@[url]www<span class="selector-class">.akadia</span><span class="selector-class">.com</span>:<span class="number">123</span>     <span class="comment">//显示那些进程打开了到www.akadia.com的UDP的123(ntp)端口的链接</span></div><div class="line">lsof -<span class="selector-tag">i</span> tcp@ohaha<span class="selector-class">.ks</span><span class="selector-class">.edu</span><span class="selector-class">.tw</span>:ftp -r      <span class="comment">//不断查看目前ftp连接的情况(-r，lsof会永远不断的执行，直到收到中断信号,+r，lsof会一直执行，直到没有档案被显示,缺省是15s刷新)</span></div><div class="line">lsof -<span class="selector-tag">i</span> tcp@ohaha<span class="selector-class">.ks</span><span class="selector-class">.edu</span><span class="selector-class">.tw</span>:ftp -n      <span class="comment">//lsof -n 不将IP转换为hostname，缺省是不加上-n参数</span></div></pre></td></tr></table></figure>
<hr>
<p><strong>Ref:</strong></p>
<p><a href="http://www.cnblogs.com/ggjucheng/archive/2012/01/08/2316599.html" target="_blank" rel="external">http://www.cnblogs.com/ggjucheng/archive/2012/01/08/2316599.html</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/09/17/ios9-http-not-work/">【转】iOS9 HTTP 不能正常使用的解决办法</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-09-17
        </span></div>
    </header>

    <div class="post-content"><p><strong>原文链接：</strong> <a href="http://segmentfault.com/a/1190000002933776" target="_blank" rel="external">http://segmentfault.com/a/1190000002933776</a></p>
<p>今天升级Xcode 7.0 bata发现网络访问失败。<br>输出错误信息</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">The<span class="built_in"> resource </span>could <span class="keyword">not</span> be loaded because the App Transport Security<span class="built_in"> policy </span>requires the use of a secure connection.</div></pre></td></tr></table></figure>
<p>Google后查证，iOS9引入了新特性<code>App Transport Security (ATS)</code>。详情：<a href="https://developer.apple.com/library/prerelease/ios/releasenotes/General/WhatsNewIniOS/Articles/iOS9.html#//apple_ref/doc/uid/TP40016198-DontLinkElementID_13" target="_blank" rel="external">App Transport Security (ATS)</a></p>
<p>新特性要求App内访问的网络必须使用<code>HTTPS</code>协议。<br>但是现在公司的项目使用的是<code>HTTP</code>协议，使用私有加密方式保证数据安全。现在也不能马上改成<code>HTTPS</code>协议传输。</p>
<p>最终找到以下解决办法：</p>
<p>1.在Info.plist中添加<code>NSAppTransportSecurity</code>类型<code>Dictionary</code>。</p>
<p>2.在<code>NSAppTransportSecurity</code>下添加<code>NSAllowsArbitraryLoads</code>类型<code>Boolean</code>,值设为<code>YES</code>。</p>
<hr>
<p><strong>参考：</strong></p>
<ul>
<li><a href="https://github.com/meteor/meteor/issues/4560" target="_blank" rel="external">App Transport Security support aka apps on iOS 9 don’t work #4560</a></li>
<li><a href="http://devstreaming.apple.com/videos/wwdc/2015/711y6zlz0ll/711/711_networking_with_nsurlsession.pdf?dl=1" target="_blank" rel="external">711_networking_with_nsurlsession.pdf</a></li>
</ul>
<hr>
<p><strong>总结：</strong></p>
<p>苹果正在加大应用安全的管控，这个举措可以看出苹果对信息安全的重视，也暴露出大部分应用传输数据时都是未经过加密的，或使用私有方式加密，以至于苹果开始对开发者提出要求。</p>
<p>私有加密虽然一定程度上是安全的，但是终究不是一个长久之计。全世界这么多安全专家在维护<code>HTTPS</code>安全，早日使用<code>HTTPS</code>确保信息安全才是王道！也省去了私有加密协议的安全隐患！</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/09/12/how-to-check-if-an-object-is-an-observer/">【译】KVO-如何检查一个对象是否是观察者？</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-09-12
        </span></div>
    </header>

    <div class="post-content"><p><strong>原文链接：<a href="http://stackoverflow.com/questions/9231896/kvo-how-to-check-if-an-object-is-an-observer" target="_blank" rel="external">KVO - How to check if an object is an observer?</a></strong></p>
<hr>
<h4 id="Nikolai-Ruhe的回答"><a href="#Nikolai-Ruhe的回答" class="headerlink" title="Nikolai Ruhe的回答:"></a><a href="http://stackoverflow.com/users/104790/nikolai-ruhe" target="_blank" rel="external">Nikolai Ruhe</a>的回答:</h4><blockquote>
<p>是否可能检查出一个对象实际上是否在观察某个属性？</p>
</blockquote>
<p>不能。当和KVO打交道时你应该谨记以下规则：</p>
<p><u>每当创建一个观察者（observer）的时候，你就要负责移除这个观察者。观察者是通过它的上下文（context）来标记唯一性的——因此，上下文必须是唯一的。当接收通知时（以及在苹果的Lion系统中，移除观察者时），你应该检查的是 <strong>上下文</strong> ，而不是path。</u></p>
<p>处理被观察对象的最佳方法是，在被观察对象的<code>setter</code>方法中移除和创建KVO事件。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> fooObservanceContext;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)<span class="string">setFoo:</span>(Foo \*)foo</div><div class="line">&#123;</div><div class="line">	[_foo <span class="string">removeObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"bar"</span> <span class="string">context:</span>&amp;fooObservanceContext];</div><div class="line"></div><div class="line">	_foo = foo; <span class="comment">// or whatever ownership handling is needed.</span></div><div class="line"></div><div class="line">	[foo <span class="string">addObserver:</span>self <span class="string">forKeyPath:</span>@<span class="string">"bar"</span> <span class="string">options:</span><span class="number">0</span> <span class="string">context:</span>&amp;fooObservanceContext];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)<span class="string">observeValueForKeyPath:</span>(NSString *)keyPath <span class="string">ofObject:</span>(id)object <span class="string">change:</span>(NSDictionary *)change <span class="string">context:</span>(<span class="keyword">void</span> \*)context</div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (context == &amp;fooObservanceContext) &#123;</div><div class="line">	    <span class="comment">// handle change</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">	    <span class="comment">// not my observer callback</span></div><div class="line">	    [<span class="keyword">super</span> <span class="string">observeValueForKeyPath:</span>keyPath <span class="string">ofObject:</span>object <span class="string">change:</span>change <span class="string">context:</span>context];</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)dealloc</div><div class="line">&#123;</div><div class="line">	self.foo = nil; <span class="comment">// removes observer</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当使用KVO时，你必须确保观察者和被观察者这两个对象的生命周期，和正在执行的KVO事件的生命周期一样长。</p>
<p>当添加一个KVO事件时，你需要衡量是否正确移除了同一个KVO事件。不要凭空假设，你是KVO的唯一使用者。框架中的类可能会根据它们自己的需求来使用KVO，所以需要在回调时检查上下文。</p>
<p>最后，我想指出的是：被观察的属性必须是支持KVO的。<a href="http://stackoverflow.com/questions/4874288/use-key-value-observing-to-get-a-kvo-callback-on-a-uiviews-frame/19701380#19701380" target="_blank" rel="external">你不可能观察任何属性</a>。</p>
<hr>
<h4 id="Rayfleck的回答"><a href="#Rayfleck的回答" class="headerlink" title="Rayfleck的回答:"></a><a href="http://stackoverflow.com/users/165050/rayfleck" target="_blank" rel="external">Rayfleck</a>的回答:</h4><p><code>NSKeyValueObserving</code> 协议中有部分是这样的：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">- (<span class="literal">void</span> <span class="string">\*)observationInfo</span></div></pre></td></tr></table></figure>
<p>它会列出观察者。但只有在debug的时候有用。<br>可以在控制台输入：<code>po [observedObject observationInfo]</code>，就可以得到一个漂亮的观察者和key path的概览。</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2015/09/12/ios-developing-tricks/">iOS Developing Tricks</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2015-09-12
        </span></div>
    </header>

    <div class="post-content"><h4 id="1-How-to-set-the-title-of-UIButton-as-left-alignment"><a href="#1-How-to-set-the-title-of-UIButton-as-left-alignment" class="headerlink" title="1.How to set the title of UIButton as left alignment?"></a>1.How to set the title of UIButton as left alignment?</h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yourBtn.contentHorizontalAlignment = UIControlContentHorizontalAlignmentLeft<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yourBtn.contentEdgeInsets = UIEdgeInsetsMake(<span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>);</div></pre></td></tr></table></figure>
<h4 id="2-UINavigationController-Hide-Back-Button-on-Only-One-View"><a href="#2-UINavigationController-Hide-Back-Button-on-Only-One-View" class="headerlink" title="2.UINavigationController: Hide Back Button on Only One View"></a>2.UINavigationController: Hide Back Button on Only One View</h4><p>Sometimes, <code>controller.navigationItem.hidesBackButton = YES/NO</code> doesn’t work at all.</p>
<p>And here’s a workaround:</p>
<p>To hide the back button, set the left bar button view to an empty view.</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">UIView *tmpView = <span class="comment">[<span class="comment">[UIView alloc]</span> initWithFrame:CGRectZero]</span>;</div><div class="line">UIBarButtonItem *tmpButtonItem = <span class="comment">[<span class="comment">[UIBarButtonItem alloc]</span> initWithCustomView:tmpView]</span>;</div><div class="line"><span class="comment">[tmpView release]</span>;</div><div class="line">self.navigationItem.leftBarButtonItem = tmpButtonItem;</div><div class="line"><span class="comment">[tmpButtonItem release]</span>;</div></pre></td></tr></table></figure>
<p>To restore the back button, just set the left bar button item to <code>nil</code>.</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="keyword">self</span>.navigationItem setLeftBarButtonItem:<span class="literal">nil</span> animated:<span class="literal">YES</span>];</div></pre></td></tr></table></figure>
<hr>
<p><strong>Ref:</strong></p>
<p><a href="http://stackoverflow.com/questions/2765024/how-to-set-the-title-of-uibutton-as-left-alignment" target="_blank" rel="external">http://stackoverflow.com/questions/2765024/how-to-set-the-title-of-uibutton-as-left-alignment</a></p>
<p><a href="http://stackoverflow.com/questions/5062405/uinavigationcontroller-hiding-back-button-on-one-view-hides-it-for-all-views" target="_blank" rel="external">http://stackoverflow.com/questions/5062405/uinavigationcontroller-hiding-back-button-on-one-view-hides-it-for-all-views</a></p>

        </div></article>
      <nav class="pagination"><a class="prev" href="/page/9/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">Prev</span>
      </a>
    <a class="next" href="/page/11/">
        <span class="next-text">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></section></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:calios_1124@163.com" class="iconfont icon-email" title="email"></a>
        <a href="http://github.com/caliosd" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2020<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Calios</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
