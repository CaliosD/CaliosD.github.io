<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Stedfast as thou art."><title>iOS的内存管理之ARC部分总结 | Calios' Eden</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iOS的内存管理之ARC部分总结</h1><a id="logo" href="/.">Calios' Eden</a><p class="description">Stedfast as thou art.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">iOS的内存管理之ARC部分总结</h1><div class="post-meta">Jun 29, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>在《Objective-C高级编程：iOS与OS X多线程和内存管理》一书中，对于ARC的部分有详尽的讲解。我将这一部分整理成思维导图，算是一个归档吧。</p>
<a id="more"></a>
<p><img src="http://7xkwcv.com1.z0.glb.clouddn.com/iOS%E7%9A%84%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.png" alt="内存管理之ARC部分"></p>
<p>如下是一些需要注意的点：</p>
<h3 id="0-id"><a href="#0-id" class="headerlink" title="0.id"></a>0.<code>id</code></h3><ul>
<li><code>id</code>是OC中对象标识的数据类型，可以用来指定任何类。<code>id</code>是所有对象的终极超类。</li>
<li><code>&lt;objc/objc.h&gt;</code>中<code>id</code>的定义：</li>
</ul>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">/// Represents an<span class="built_in"> instance </span>of a class.</div><div class="line">struct objc_object &#123;</div><div class="line">    Class isa  OBJC_ISA_AVAI<span class="class">LABILITY;</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">/// A pointer to an<span class="built_in"> instance </span>of a class.</div><div class="line">typedef struct objc_object *id;</div></pre></td></tr></table></figure>
<ul>
<li>虽然看起来是指向结构体的指针，但对于OC的编译器而言，<code>id</code>使得原本的静态类型的语言变得动态起来。这就意味着，它指向的对象的类型是不被编译器检查的。</li>
<li>ARC有效时，<code>id</code>类型和对象类型同C语言其他类型不同，其类型上必须附加所有权修饰符，包括：<code>__strong</code>，<code>__weak</code>，<code>__unsafe_unretain</code>和<code>__autoreleasing</code>修饰符。</li>
<li><code>__strong</code>，<code>__weak</code>和<code>__autoreleasing</code>修饰符一起，可以保证将附有这些修饰符的自动变量初始化为<code>nil</code>。</li>
</ul>
<h3 id="1-引用计数规则"><a href="#1-引用计数规则" class="headerlink" title="1.引用计数规则"></a>1.引用计数规则</h3><ul>
<li>谁使用谁释放，谁创建谁释放。（谁污染谁治理 =。=）</li>
</ul>
<h3 id="2-是在预编译-编译-链接-运行-哪个阶段进行？"><a href="#2-是在预编译-编译-链接-运行-哪个阶段进行？" class="headerlink" title="2.是在预编译/编译/链接/运行 哪个阶段进行？"></a>2.是在预编译/编译/链接/运行 哪个阶段进行？</h3><ul>
<li>所有的retain、release、strong属性的会在编译时处理。</li>
<li>weak属性会在运行时处理。</li>
</ul>
<h3 id="3-strong、-weak、-unsafe-unretain"><a href="#3-strong、-weak、-unsafe-unretain" class="headerlink" title="3.__strong、__weak、__unsafe_unretain"></a>3.<code>__strong</code>、<code>__weak</code>、<code>__unsafe_unretain</code></h3><ul>
<li><code>__strong</code>：是<code>id</code>类型和<strong>对象类型</strong>默认的所有权修饰符。附有<code>__strong</code>修饰符的变量，在超出其变量作用域时，即在该变量被废弃时，会释放其被赋予的对象。表示逻辑上强持有一个对象。规则是：指针被赋值时同时进行retain处理；指针销毁时对指针的内容进行release。</li>
<li><code>__weak</code>：指针被赋值时，不会对所赋的对象进行retain，意味着引用计数会随时为零，一旦为零，就会被置为<code>nil</code>，也就是说，要再引用计数为零之前置为<code>nil</code>。</li>
<li><code>__unsafe_unretain</code>：不安全的不持有。规则是：声明一个指针，对赋值的对象不进行retain，如果对象为零了，那么指针会继续指向这个对象。</li>
<li><code>__weak</code>会有性能损耗，所以在处理极大对象的时候会使用<code>__unsafe_unretain</code>属性。</li>
</ul>
<h3 id="4-strong，weak，assign"><a href="#4-strong，weak，assign" class="headerlink" title="4.strong，weak，assign"></a>4.<code>strong</code>，<code>weak</code>，<code>assign</code></h3><ul>
<li><code>strong</code>：和<code>__strong</code>是一样的，在dealloc的时候release。</li>
<li><code>weak</code>：和<code>__weak</code>是一样的，一旦引用计数变为零，会自动置为<code>nil</code>。</li>
<li><code>assign</code>：能够声明很多标量（float，int等），用它来声明变量时，和<code>__unsafe_unretain</code>一样，声明一个指针的时候会对它进行持有，当为零的时候也不会自动释放。</li>
</ul>
<h3 id="5-weak详解"><a href="#5-weak详解" class="headerlink" title="5.weak详解"></a>5.<code>weak</code>详解</h3><ul>
<li>工作在运行时：编译时是按照逻辑编译单元（一个.m文件）进行编译的，在一个编译单元中无法知道其他编译单元的情况，无法判断是否为零、是否需要置为<code>nil</code>。</li>
<li>如何置为<code>nil</code>：底层有一个哈希表，哈希表中存储所有weak指向的对象。用weak指针指向的值（对象的地址，是一个栈/堆上的变量）作为key，所有指向它的地址作为value。每当对象dealloc时，就会检查这个表，同时把表中所有指向这个对象的指针都置为nil。</li>
</ul>
<h3 id="6-归零弱引用（Zeroing-weak-reference）"><a href="#6-归零弱引用（Zeroing-weak-reference）" class="headerlink" title="6.归零弱引用（Zeroing weak reference）"></a>6.归零弱引用（Zeroing weak reference）</h3><p>即让对象自己去清空弱引用的对象，这种特殊的弱引用被称为归零弱引用。在它指向的对象释放后，这些弱引用会被设置为零（即nil）。</p>
<p>有两种方式可以声明归零弱引用：</p>
<ul>
<li>声明变量时使用<code>__weak</code>关键字或对属性使用weak特性。</li>
<li>在不支持弱引用的旧系统上，可以使用苹果公司提供的<code>__unsafe_unretained</code>关键字和<code>unsafe_unretained</code>特性。</li>
</ul>
<h3 id="7-循环引用"><a href="#7-循环引用" class="headerlink" title="7.循环引用"></a>7.循环引用</h3><ul>
<li><code>a.propertyB = b; b.propertyA = a;</code> b的引用计数+1，a的引用计数+1。引用计数一直无法为零，造成循环引用。</li>
<li>如何解？<ul>
<li>原因在于，b和a都会引用计数至少为1。</li>
<li>暴力解法：b或者a多调用一下release。然后就挂了。ㄟ( ▔. ▔ )ㄏ</li>
<li>简单解法：任何一端置为nil。</li>
</ul>
</li>
</ul>
<h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h3><ul>
<li>《Objective-C高级编程：iOS与OS X多线程和内存管理》</li>
<li>臧成威《现代OC内存管理》：<a href="http://www.stuq.org/course/1044/courseware/1594" target="_blank" rel="external">http://www.stuq.org/course/1044/courseware/1594</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://www.caliosd.gq/2017/06/29/iOS的内存管理之ARC部分总结/" data-id="cj59cqno0003ka8515gjs5x68" class="article-share-link">分享</a><div class="tags"><a href="/tags/iOS/">iOS</a><a href="/tags/ARC/">ARC</a><a href="/tags/内存管理/">内存管理</a></div><div class="post-nav"><a href="/2017/06/28/关于copy的常见问题/" class="next">关于copy的常见问题</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.caliosd.gq"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/TextKit/" style="font-size: 15px;">TextKit</a> <a href="/tags/AVPlayer/" style="font-size: 15px;">AVPlayer</a> <a href="/tags/AutoLayout/" style="font-size: 15px;">AutoLayout</a> <a href="/tags/Background/" style="font-size: 15px;">Background</a> <a href="/tags/PragmaticProgrammer/" style="font-size: 15px;">PragmaticProgrammer</a> <a href="/tags/Bash/" style="font-size: 15px;">Bash</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/Block/" style="font-size: 15px;">Block</a> <a href="/tags/CAS/" style="font-size: 15px;">CAS</a> <a href="/tags/CoreAnimation/" style="font-size: 15px;">CoreAnimation</a> <a href="/tags/iOS8/" style="font-size: 15px;">iOS8</a> <a href="/tags/UIKit/" style="font-size: 15px;">UIKit</a> <a href="/tags/C语言/" style="font-size: 15px;">C语言</a> <a href="/tags/Runtime/" style="font-size: 15px;">Runtime</a> <a href="/tags/EnjoyMyCoffee/" style="font-size: 15px;">EnjoyMyCoffee</a> <a href="/tags/GPS/" style="font-size: 15px;">GPS</a> <a href="/tags/Foundation/" style="font-size: 15px;">Foundation</a> <a href="/tags/property/" style="font-size: 15px;">property</a> <a href="/tags/KVC/" style="font-size: 15px;">KVC</a> <a href="/tags/KVO/" style="font-size: 15px;">KVO</a> <a href="/tags/LLDB/" style="font-size: 15px;">LLDB</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/Objective-C/" style="font-size: 15px;">Objective-C</a> <a href="/tags/Regex/" style="font-size: 15px;">Regex</a> <a href="/tags/Xcode/" style="font-size: 15px;">Xcode</a> <a href="/tags/TesseractOCR/" style="font-size: 15px;">TesseractOCR</a> <a href="/tags/SolutionSummary/" style="font-size: 15px;">SolutionSummary</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/UICollectionView/" style="font-size: 15px;">UICollectionView</a> <a href="/tags/Swift/" style="font-size: 15px;">Swift</a> <a href="/tags/Chrome/" style="font-size: 15px;">Chrome</a> <a href="/tags/WebSocket/" style="font-size: 15px;">WebSocket</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/Markdown/" style="font-size: 15px;">Markdown</a> <a href="/tags/SourceRead/" style="font-size: 15px;">SourceRead</a> <a href="/tags/Clang/" style="font-size: 15px;">Clang</a> <a href="/tags/RichText/" style="font-size: 15px;">RichText</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/ARC/" style="font-size: 15px;">ARC</a> <a href="/tags/内存管理/" style="font-size: 15px;">内存管理</a> <a href="/tags/Terminal/" style="font-size: 15px;">Terminal</a> <a href="/tags/脑洞开一开/" style="font-size: 15px;">脑洞开一开</a> <a href="/tags/译言/" style="font-size: 15px;">译言</a> <a href="/tags/NotToCrashSeries/" style="font-size: 15px;">NotToCrashSeries</a> <a href="/tags/iOS9/" style="font-size: 15px;">iOS9</a> <a href="/tags/Download/" style="font-size: 15px;">Download</a> <a href="/tags/NSURLSession/" style="font-size: 15px;">NSURLSession</a> <a href="/tags/copy/" style="font-size: 15px;">copy</a> <a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/Vim/" style="font-size: 15px;">Vim</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/JumpNStruggleOut/" style="font-size: 15px;">JumpNStruggleOut</a> <a href="/tags/Summary/" style="font-size: 15px;">Summary</a> <a href="/tags/Storyboard/" style="font-size: 15px;">Storyboard</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/iOS的内存管理之ARC部分总结/">iOS的内存管理之ARC部分总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/28/关于copy的常见问题/">关于copy的常见问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/30/Issue-of-lazy-loading-property/">Issue of lazy loading property</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/KVO-KVC-missing-points/">KVO & KVC 知识点小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/23/随笔一则-0422/">随笔一则-0422-美团沙龙面基</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/19/WebSocket初探/">WebSocket初探</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/15/Regex-Notes/">Regex Notes</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/12/CAS登录之iOS端总结/">CAS登录之iOS端总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/22/GPS-and-related/">GPS and related</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/16/Objective-C-Runtime-Programming-Guide-翻译及详解/">Objective-C Runtime Programming Guide 翻译及详解</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Calios' Eden.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>